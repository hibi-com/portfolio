# 案件管理

## ストーリー

**As a** CRM User（CRMユーザー）
**I want to** 案件（商談）をパイプラインで管理したい
**So that** 営業プロセスを可視化し、成約率を向上させられる

## ペルソナ

| 属性 | 値 |
| ---- | -- |
| 名前 | CRM User |
| 役割 | crm-user |
| 技術レベル | 中級者 |
| 主な目的 | 案件パイプライン管理 |

## 前提条件

- CRMユーザーとしてログイン済み
- CRM機能へのアクセス権限がある

## 受け入れ条件（Acceptance Criteria）

### AC1: パイプラインビューの表示

**Given** CRMユーザーがログインしている
**When** 案件管理ページにアクセスする
**Then** カンバン形式でパイプラインが表示される

### AC2: 新規案件の作成

**Given** パイプラインビューにいる
**When** 「新規案件」ボタンをクリックし、案件情報を入力して保存する
**Then** 新しい案件が作成され、パイプラインに表示される

### AC3: 案件のステージ移動

**Given** パイプラインに案件が存在する
**When** 案件カードをドラッグして別のステージにドロップする
**Then** 案件のステージが更新される

### AC4: 案件詳細の表示と編集

**Given** パイプラインに案件が存在する
**When** 案件カードをクリックする
**Then** 案件の詳細が表示され、編集できる

### AC5: 案件の勝敗マーク

**Given** 案件詳細ページにいる
**When** 「成約」または「失注」ボタンをクリックする
**Then** 案件がクローズされ、統計に反映される

### AC6: パイプライン管理

**Given** 管理者権限がある
**When** パイプライン設定ページでステージを追加/編集/削除する
**Then** パイプラインのステージ構成が更新される

## シナリオ

### 正常系シナリオ（案件の進捗管理）

1. CRMユーザーは管理画面にログインする
2. サイドバーから「案件」をクリックする
3. カンバン形式のパイプラインが表示される
4. 「見込み」ステージの案件カードをドラッグする
5. 「提案」ステージにドロップする
6. 案件のステージが「提案」に更新される
7. 成約時は案件詳細から「成約」をクリック
8. 案件がクローズされ、「成約」カラムに移動

### パイプラインステージ

```text
見込み → 提案 → 交渉 → 成約
                   ↓
                 失注
```

## UI/UX要件

### 画面構成

```text
┌─────────────────────────────────────────────────────────┐
│ Header (Navigation)                                      │
├──────────┬──────────────────────────────────────────────┤
│          │ 案件パイプライン        [新規案件] [設定]    │
│ Sidebar  ├──────────────────────────────────────────────┤
│          │ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ │
│          │ │ 見込み │ │ 提案   │ │ 交渉   │ │ 成約   │ │
│          │ ├────────┤ ├────────┤ ├────────┤ ├────────┤ │
│          │ │┌──────┐│ │┌──────┐│ │        │ │┌──────┐│ │
│          │ ││案件A ││ ││案件C ││ │        │ ││案件E ││ │
│          │ │└──────┘│ │└──────┘│ │        │ │└──────┘│ │
│          │ │┌──────┐│ │        │ │        │ │        │ │
│          │ ││案件B ││ │        │ │        │ │        │ │
│          │ │└──────┘│ │        │ │        │ │        │ │
│          │ └────────┘ └────────┘ └────────┘ └────────┘ │
└──────────┴──────────────────────────────────────────────┘
```

### 必要な要素

| 要素 | 種類 | 説明 |
| ---- | ---- | ---- |
| パイプラインボード | kanban | ドラッグ&ドロップ対応 |
| 案件カード | card | 案件名、金額、顧客名を表示 |
| 新規案件ボタン | button | 案件作成モーダルを表示 |
| ステージ列 | column | 各ステージの案件を表示 |
| 集計バー | stats | ステージ別の金額合計を表示 |

### インタラクション

| アクション | 結果 |
| ---------- | ---- |
| カードをドラッグ | ステージ間で案件を移動 |
| カードをクリック | 案件詳細モーダルを表示 |
| 成約ボタン | 案件を成約としてクローズ |
| 失注ボタン | 案件を失注としてクローズ |

## テスト

### E2Eテスト

- ファイル: `apps/admin/e2e/large/crm-user/manage-deals.large.spec.ts`
- 対応するAC: AC1, AC2, AC3, AC4, AC5, AC6

### テストシナリオ

| シナリオ | AC | 自動化 |
| -------- | -- | ------ |
| パイプライン表示 | AC1 | Yes |
| 新規案件作成 | AC2 | Yes |
| ステージ移動 | AC3 | Yes |
| 詳細表示・編集 | AC4 | Yes |
| 成約/失注マーク | AC5 | Yes |
| パイプライン設定 | AC6 | Yes |

## 関連

- シーケンス図: `docs/sequence/api/crm/deal-*.md`
- API仕様: `docs/specs/api/crm.md`
- 画面: `apps/admin/app/routes/crm/deals/`
