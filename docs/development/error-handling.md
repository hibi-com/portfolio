---
title: "エラーハンドリング"
---

フロントエンドおよび API でエラーを扱う際のルールである。  
実装例はリポジトリの ErrorBoundary・widgets/error・ローダー/アクションを参照すること。

## エラーバウンダリ（Remix）

- **root** で **ErrorBoundary** をエクスポートし、**useRouteError** でエラーを受け取ってユーザー向けのエラーページを表示する。未処理の例外をそのまま表示しない。
- ルート単位でも **ErrorBoundary** を定義し、そのルート固有のメッセージを出してよい。
- エラー表示コンポーネントは **widgets/error** 等にまとめ、Response と Error の両方を扱えるようにする（status と message を表示）。

## ローダー内のエラー

- データ取得失敗・不正なパラメータは **throw new Response(..., { status: 400 | 404 | 500 })** で返す。空の JSON で 200 を返してはならない。
- バリデーション（Zod 等）でパラメータを検証し、失敗時は 400 で返す。エラーメッセージはユーザーに分かる文言にする。
- try-catch で例外を捕捉し、適切なステータスで Response を throw する。握りつぶして 200 を返さない。

## アクション（フォーム）のエラー

- バリデーション失敗時は **json({ errors: ... }, { status: 400 })** を返す。**useActionData** で errors を受け取り、フィールド横に表示する。
- サーバーエラー時は 500 とメッセージを返し、画面で「しばらくして再試行」等を表示する。

## 非同期・API 呼び出し

- **async/await** を使い、失敗時は try-catch で処理する。**response.ok** が false の場合はエラーとして扱い、ステータスに応じてメッセージを出す。
- エラーはログに残し、本番ではユーザーにスタックトレースや内部詳細を見せない。

## 本番環境のログ

- エラーバウンダリや API クライアントで捕捉したエラーは、本番では Sentry 等に送信する。**process.env.NODE_ENV === "production"** のときのみ送信する等、環境で分岐する。
- ユーザーには「問題が発生しました」等の一般的なメッセージのみ表示する。

## 禁止事項

- ローダー・アクションで例外を無視して 200 を返さない。
- バリデーションエラーを 200 で返さない（400 とする）。
- 本番でスタックトレースや内部エラー文をそのまま表示しない。
- ErrorBoundary を定義せずにルートを公開しない。
