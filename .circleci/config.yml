version: 2.1

orbs:
  node: circleci/node@7.1.0
  browser-tools: circleci/browser-tools@1.5.0

executors:
  default:
    docker:
      - image: cimg/node:22.12
    resource_class: medium
    working_directory: ~/project

  large:
    docker:
      - image: cimg/node:22.12-browsers
    resource_class: large
    working_directory: ~/project

commands:
  install-bun:
    description: Install Bun runtime
    steps:
      - run:
          name: Install Bun
          command: |
            curl -fsSL https://bun.sh/install | bash
            echo 'export BUN_INSTALL="$HOME/.bun"' >> $BASH_ENV
            echo 'export PATH="$BUN_INSTALL/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV

  install-b2:
    description: Install Backblaze B2 CLI
    steps:
      - run:
          name: Install b2-tools
          command: |
            pip3 install --upgrade b2
            echo 'export PATH="$HOME/.local/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV

  restore-deps:
    description: Restore cached dependencies
    steps:
      - restore_cache:
          keys:
            - bun-deps-v1-{{ checksum "bun.lock" }}
            - bun-deps-v1-

  save-deps:
    description: Save dependencies to cache
    steps:
      - save_cache:
          key: bun-deps-v1-{{ checksum "bun.lock" }}
          paths:
            - node_modules
            - ~/.bun

  restore-turbo:
    description: Restore Turborepo cache
    steps:
      - restore_cache:
          keys:
            - turbo-cache-v1-{{ .Branch }}-{{ .Revision }}
            - turbo-cache-v1-{{ .Branch }}-
            - turbo-cache-v1-

  save-turbo:
    description: Save Turborepo cache
    steps:
      - save_cache:
          key: turbo-cache-v1-{{ .Branch }}-{{ .Revision }}
          paths:
            - .turbo

jobs:
  setup:
    executor: default
    steps:
      - checkout
      - install-bun
      - restore-deps
      - run:
          name: Install dependencies
          command: bun install --frozen-lockfile
      - run:
          name: Run setup
          command: bun run setup
      - save-deps
      - restore-turbo
      - save-turbo
      - persist_to_workspace:
          root: .
          paths:
            - .
            - node_modules
            - packages/*/node_modules
            - apps/*/node_modules

  format:
    executor: default
    steps:
      - attach_workspace:
          at: .
      - install-bun
      - run:
          name: Format check TypeScript
          command: bun run fmt:check

  lint:
    executor: default
    steps:
      - attach_workspace:
          at: .
      - install-bun
      - run:
          name: Lint TypeScript
          command: bun run lint

  typecheck:
    executor: default
    steps:
      - attach_workspace:
          at: .
      - install-bun
      - run:
          name: Typecheck
          command: bun run typecheck

  test:
    executor: default
    steps:
      - attach_workspace:
          at: .
      - install-bun
      - run:
          name: Run unit tests
          command: bun run test
      - store_test_results:
          path: .results
      - run:
          name: Create GitHub Issue on failure
          when: on_fail
          command: |
            if [ -n "${GITHUB_TOKEN}" ]; then
              curl -X POST \
                -H "Authorization: token ${GITHUB_TOKEN}" \
                -H "Accept: application/vnd.github.v3+json" \
                https://api.github.com/repos/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/issues \
                -d "{
                  \"title\": \"[CI Failure] Unit tests failed on ${CIRCLE_BRANCH}\",
                  \"body\": \"## CI Failure Report\n\n**Job:** test\n**Branch:** ${CIRCLE_BRANCH}\n**Commit:** ${CIRCLE_SHA1}\n**Build:** [#${CIRCLE_BUILD_NUM}](${CIRCLE_BUILD_URL})\n\n### Actions Required\n\n- [ ] Review the build logs\n- [ ] Fix the failing tests\n- [ ] Re-run the CI pipeline\",
                  \"labels\": [\"ci-failure\", \"automated\"]
                }"
            fi

  e2e:
    executor: large
    steps:
      - attach_workspace:
          at: .
      - install-bun
      - browser-tools/install-chrome
      - browser-tools/install-chromedriver
      - run:
          name: Install Playwright browsers
          command: |
            bun add -g @playwright/test
            bunx playwright install --with-deps chromium
      - run:
          name: Run E2E tests
          command: bun run e2e
          no_output_timeout: 20m
      - store_artifacts:
          path: docs/playwright/report
          destination: playwright-report
      - store_test_results:
          path: .results
      - run:
          name: Create GitHub Issue on failure
          when: on_fail
          command: |
            if [ -n "${GITHUB_TOKEN}" ]; then
              curl -X POST \
                -H "Authorization: token ${GITHUB_TOKEN}" \
                -H "Accept: application/vnd.github.v3+json" \
                https://api.github.com/repos/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/issues \
                -d "{
                  \"title\": \"[CI Failure] E2E tests failed on ${CIRCLE_BRANCH}\",
                  \"body\": \"## CI Failure Report\n\n**Job:** e2e\n**Branch:** ${CIRCLE_BRANCH}\n**Commit:** ${CIRCLE_SHA1}\n**Build:** [#${CIRCLE_BUILD_NUM}](${CIRCLE_BUILD_URL})\n\n### Actions Required\n\n- [ ] Review the Playwright report\n- [ ] Fix the failing E2E tests\n- [ ] Re-run the CI pipeline\",
                  \"labels\": [\"ci-failure\", \"e2e\", \"automated\"]
                }"
            fi

  build:
    executor: default
    steps:
      - attach_workspace:
          at: .
      - install-bun
      - restore-turbo
      - run:
          name: Build application
          command: bun run build
      - save-turbo
      - persist_to_workspace:
          root: .
          paths:
            - apps/*/dist
            - apps/*/build
            - packages/*/dist
      - run:
          name: Create GitHub Issue on failure
          when: on_fail
          command: |
            if [ -n "${GITHUB_TOKEN}" ]; then
              curl -X POST \
                -H "Authorization: token ${GITHUB_TOKEN}" \
                -H "Accept: application/vnd.github.v3+json" \
                https://api.github.com/repos/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/issues \
                -d "{
                  \"title\": \"[CI Failure] Build failed on ${CIRCLE_BRANCH}\",
                  \"body\": \"## CI Failure Report\n\n**Job:** build\n**Branch:** ${CIRCLE_BRANCH}\n**Commit:** ${CIRCLE_SHA1}\n**Build:** [#${CIRCLE_BUILD_NUM}](${CIRCLE_BUILD_URL})\n\n### Actions Required\n\n- [ ] Review the build logs\n- [ ] Fix the build errors\n- [ ] Re-run the CI pipeline\",
                  \"labels\": [\"ci-failure\", \"build\", \"automated\"]
                }"
            fi

  upload-artifacts:
    executor: default
    steps:
      - attach_workspace:
          at: .
      - install-b2
      - run:
          name: Upload artifacts to Backblaze B2
          command: |
            b2 authorize-account "${B2_APPLICATION_KEY_ID}" "${B2_APPLICATION_KEY}"

            ARTIFACT_PATH="artifacts/${CIRCLE_SHA1}"

            for app in web api admin; do
              APP_DIST="apps/${app}/dist"
              APP_BUILD="apps/${app}/build"

              if [ -d "${APP_DIST}" ]; then
                echo "Uploading ${APP_DIST}..."
                b2 sync "${APP_DIST}" "b2://${B2_BUCKET_NAME}/${ARTIFACT_PATH}/${app}/dist/" --skipNewer
              fi

              if [ -d "${APP_BUILD}" ]; then
                echo "Uploading ${APP_BUILD}..."
                b2 sync "${APP_BUILD}" "b2://${B2_BUCKET_NAME}/${ARTIFACT_PATH}/${app}/build/" --skipNewer
              fi
            done

            echo "{\"sha\": \"${CIRCLE_SHA1}\", \"branch\": \"${CIRCLE_BRANCH}\", \"build_num\": ${CIRCLE_BUILD_NUM}, \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" > manifest.json
            b2 upload-file "${B2_BUCKET_NAME}" manifest.json "${ARTIFACT_PATH}/manifest.json"

  download-artifacts:
    executor: default
    parameters:
      commit_sha:
        type: string
        default: ""
    steps:
      - checkout
      - install-b2
      - run:
          name: Download artifacts from Backblaze B2
          command: |
            b2 authorize-account "${B2_APPLICATION_KEY_ID}" "${B2_APPLICATION_KEY}"

            SHA="${<< parameters.commit_sha >>}"
            if [ -z "${SHA}" ]; then
              SHA="${CIRCLE_SHA1}"
            fi

            ARTIFACT_PATH="artifacts/${SHA}"

            mkdir -p artifacts
            b2 sync "b2://${B2_BUCKET_NAME}/${ARTIFACT_PATH}/" "./artifacts/${SHA}/" --skipNewer
      - persist_to_workspace:
          root: .
          paths:
            - artifacts

  deploy:
    executor: default
    parameters:
      environment:
        type: enum
        enum: [rc, stg, prd]
    steps:
      - attach_workspace:
          at: .
      - install-bun
      - run:
          name: Install Wrangler CLI
          command: |
            bun add -g wrangler@latest
            wrangler --version
      - run:
          name: Install Doppler CLI with retry
          command: |
            for i in 1 2 3; do
              if sudo apt-get update && sudo apt-get install -y apt-transport-https ca-certificates gnupg curl; then
                if curl -sLf --retry 3 --tlsv1.2 --proto "=https" 'https://packages.doppler.com/public/cli/gpg.DE2A7741A397C129.key' | sudo gpg --dearmor -o /usr/share/keyrings/doppler-archive-keyring.gpg; then
                  echo "deb [signed-by=/usr/share/keyrings/doppler-archive-keyring.gpg] https://packages.doppler.com/public/cli/deb/debian any-version main" | sudo tee /etc/apt/sources.list.d/doppler-cli.list
                  if sudo apt-get update && sudo apt-get install -y doppler; then
                    doppler --version
                    break
                  fi
                fi
              fi
              echo "Attempt $i failed, retrying..."
              sleep 5
            done
      - run:
          name: Setup Cloudflare credentials
          command: |
            export CLOUDFLARE_API_TOKEN="${CLOUDFLARE_API_TOKEN}"
            echo "Cloudflare credentials configured"
      - run:
          name: Deploy to << parameters.environment >>
          command: |
            export DOPPLER_CONFIG="<< parameters.environment >>"

            echo "=== Deploying to << parameters.environment >> environment ==="
            echo "Commit: ${CIRCLE_SHA1}"
            echo "Build: ${CIRCLE_BUILD_NUM}"

            # Deploy with retry logic
            MAX_RETRIES=3
            RETRY_COUNT=0

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              echo "Deploy attempt $((RETRY_COUNT + 1))/$MAX_RETRIES"

              if bun run deploy; then
                echo "✓ Deploy succeeded"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "Deploy failed, retrying in 10 seconds..."
                  sleep 10
                else
                  echo "✗ Deploy failed after $MAX_RETRIES attempts"
                  exit 1
                fi
              fi
            done
          no_output_timeout: 15m
      - run:
          name: Verify deployment
          command: |
            echo "=== Verifying deployment ==="

            # Wait for propagation
            sleep 30

            # Health check URLs based on environment
            case "<< parameters.environment >>" in
              rc)
                WEB_URL="https://rc.www.${DOMAIN:-example.com}"
                API_URL="https://rc.api.${DOMAIN:-example.com}/health"
                ;;
              stg)
                WEB_URL="https://stg.www.${DOMAIN:-example.com}"
                API_URL="https://stg.api.${DOMAIN:-example.com}/health"
                ;;
              prd)
                WEB_URL="https://www.${DOMAIN:-example.com}"
                API_URL="https://api.${DOMAIN:-example.com}/health"
                ;;
            esac

            echo "Checking Web: $WEB_URL"
            if curl -sSf -o /dev/null -w "%{http_code}" "$WEB_URL" | grep -q "200"; then
              echo "✓ Web is accessible"
            else
              echo "⚠ Web health check failed (may be expected during initial deploy)"
            fi

            echo "Checking API: $API_URL"
            if curl -sSf -o /dev/null -w "%{http_code}" "$API_URL" | grep -q "200"; then
              echo "✓ API is healthy"
            else
              echo "⚠ API health check failed (may be expected during initial deploy)"
            fi
      - run:
          name: Create GitHub Issue on failure
          when: on_fail
          command: |
            if [ -n "${GITHUB_TOKEN}" ]; then
              curl -X POST \
                -H "Authorization: token ${GITHUB_TOKEN}" \
                -H "Accept: application/vnd.github.v3+json" \
                https://api.github.com/repos/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/issues \
                -d "{
                  \"title\": \"[Deploy Failure] << parameters.environment >> deployment failed on ${CIRCLE_BRANCH}\",
                  \"body\": \"## Deployment Failure Report\n\n**Environment:** << parameters.environment >>\n**Branch:** ${CIRCLE_BRANCH}\n**Commit:** ${CIRCLE_SHA1}\n**Build:** [#${CIRCLE_BUILD_NUM}](${CIRCLE_BUILD_URL})\n\n### Actions Required\n\n- [ ] Review the deployment logs\n- [ ] Check Cloudflare dashboard\n- [ ] Verify Doppler configuration\n- [ ] Consider rollback if necessary\n\n### Rollback Command\n\n\`\`\`bash\nwrangler pages deployment rollback --project-name portfolio-web\n\`\`\`\",
                  \"labels\": [\"deployment-failure\", \"<< parameters.environment >>\", \"automated\"]
                }"
            fi

workflows:
  ci:
    jobs:
      - setup:
          filters:
            branches:
              ignore:
                - /^copilot\/.*/

      - format:
          requires:
            - setup

      - lint:
          requires:
            - setup

      - typecheck:
          requires:
            - setup

      - test:
          requires:
            - format
            - lint
            - typecheck

      - e2e:
          requires:
            - test

      - build:
          requires:
            - e2e

      - upload-artifacts:
          requires:
            - build
          context: backblaze-b2
          filters:
            branches:
              only:
                - master
                - main

  deploy-rc:
    when:
      and:
        - equal: [ master, << pipeline.git.branch >> ]
    jobs:
      - download-artifacts:
          context: backblaze-b2

      - hold-approval:
          type: approval
          requires:
            - download-artifacts

      - deploy:
          environment: rc
          requires:
            - hold-approval
          context:
            - backblaze-b2
            - cloudflare
            - doppler

  deploy-stg:
    triggers:
      - schedule:
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - master
    jobs:
      - setup

      - test:
          requires:
            - setup

      - e2e:
          requires:
            - test

      - download-artifacts:
          requires:
            - e2e
          context: backblaze-b2

      - deploy:
          environment: stg
          requires:
            - download-artifacts
          context:
            - backblaze-b2
            - cloudflare
            - doppler

  deploy-prd:
    triggers:
      - schedule:
          cron: "0 12 * * *"
          filters:
            branches:
              only:
                - master
    jobs:
      - setup

      - test:
          requires:
            - setup

      - e2e:
          requires:
            - test

      - download-artifacts:
          requires:
            - e2e
          context: backblaze-b2

      - deploy:
          environment: prd
          requires:
            - download-artifacts
          context:
            - backblaze-b2
            - cloudflare
            - doppler
