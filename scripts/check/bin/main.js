#!/usr/bin/env bun
// @bun
var hn=Object.create;var{getPrototypeOf:dn,defineProperty:X,getOwnPropertyNames:fn}=Object;var bn=Object.prototype.hasOwnProperty;var B=(t,n,s)=>{s=t!=null?hn(dn(t)):{};let e=n||!t||!t.__esModule?X(s,"default",{value:t,enumerable:!0}):s;for(let a of fn(t))if(!bn.call(e,a))X(e,a,{get:()=>t[a],enumerable:!0});return e};var pn=(t,n)=>()=>(n||t((n={exports:{}}).exports,n),n.exports);var C=pn((Yt,H)=>{var V=process||{},D=V.argv||[],N=V.env||{},In=!(!!N.NO_COLOR||D.includes("--no-color"))&&(!!N.FORCE_COLOR||D.includes("--color")||V.platform==="win32"||(V.stdout||{}).isTTY&&N.TERM!=="dumb"||!!N.CI),Pn=(t,n,s=t)=>(e)=>{let a=""+e,r=a.indexOf(n,t.length);return~r?t+Tn(a,n,s,r)+n:t+a+n},Tn=(t,n,s,e)=>{let a="",r=0;do a+=t.substring(r,e)+s,r=e+n.length,e=t.indexOf(n,r);while(~e);return a+t.substring(r)},nn=(t=In)=>{let n=t?Pn:()=>String;return{isColorSupported:t,reset:n("\x1B[0m","\x1B[0m"),bold:n("\x1B[1m","\x1B[22m","\x1B[22m\x1B[1m"),dim:n("\x1B[2m","\x1B[22m","\x1B[22m\x1B[2m"),italic:n("\x1B[3m","\x1B[23m"),underline:n("\x1B[4m","\x1B[24m"),inverse:n("\x1B[7m","\x1B[27m"),hidden:n("\x1B[8m","\x1B[28m"),strikethrough:n("\x1B[9m","\x1B[29m"),black:n("\x1B[30m","\x1B[39m"),red:n("\x1B[31m","\x1B[39m"),green:n("\x1B[32m","\x1B[39m"),yellow:n("\x1B[33m","\x1B[39m"),blue:n("\x1B[34m","\x1B[39m"),magenta:n("\x1B[35m","\x1B[39m"),cyan:n("\x1B[36m","\x1B[39m"),white:n("\x1B[37m","\x1B[39m"),gray:n("\x1B[90m","\x1B[39m"),bgBlack:n("\x1B[40m","\x1B[49m"),bgRed:n("\x1B[41m","\x1B[49m"),bgGreen:n("\x1B[42m","\x1B[49m"),bgYellow:n("\x1B[43m","\x1B[49m"),bgBlue:n("\x1B[44m","\x1B[49m"),bgMagenta:n("\x1B[45m","\x1B[49m"),bgCyan:n("\x1B[46m","\x1B[49m"),bgWhite:n("\x1B[47m","\x1B[49m"),blackBright:n("\x1B[90m","\x1B[39m"),redBright:n("\x1B[91m","\x1B[39m"),greenBright:n("\x1B[92m","\x1B[39m"),yellowBright:n("\x1B[93m","\x1B[39m"),blueBright:n("\x1B[94m","\x1B[39m"),magentaBright:n("\x1B[95m","\x1B[39m"),cyanBright:n("\x1B[96m","\x1B[39m"),whiteBright:n("\x1B[97m","\x1B[39m"),bgBlackBright:n("\x1B[100m","\x1B[49m"),bgRedBright:n("\x1B[101m","\x1B[49m"),bgGreenBright:n("\x1B[102m","\x1B[49m"),bgYellowBright:n("\x1B[103m","\x1B[49m"),bgBlueBright:n("\x1B[104m","\x1B[49m"),bgMagentaBright:n("\x1B[105m","\x1B[49m"),bgCyanBright:n("\x1B[106m","\x1B[49m"),bgWhiteBright:n("\x1B[107m","\x1B[49m")}};H.exports=nn();H.exports.createColors=nn});import{EventEmitter as xn}from"events";function q(t){return t==null?[]:Array.isArray(t)?t:[t]}function wn(t,n,s,e){var a,r=t[n],i=~e.string.indexOf(n)?s==null||s===!0?"":String(s):typeof s==="boolean"?s:~e.boolean.indexOf(n)?s==="false"?!1:s==="true"||(t._.push((a=+s,a*0===0)?a:s),!!s):(a=+s,a*0===0)?a:s;t[n]=r==null?i:Array.isArray(r)?r.concat(i):[r,i]}function $n(t,n){t=t||[],n=n||{};var s,e,a,r,i,m={_:[]},c=0,u=0,o=0,h=t.length;let x=n.alias!==void 0,j=n.unknown!==void 0,Y=n.default!==void 0;if(n.alias=n.alias||{},n.string=q(n.string),n.boolean=q(n.boolean),x)for(s in n.alias){e=n.alias[s]=q(n.alias[s]);for(c=0;c<e.length;c++)(n.alias[e[c]]=e.concat(s)).splice(c,1)}for(c=n.boolean.length;c-- >0;){e=n.alias[n.boolean[c]]||[];for(u=e.length;u-- >0;)n.boolean.push(e[u])}for(c=n.string.length;c-- >0;){e=n.alias[n.string[c]]||[];for(u=e.length;u-- >0;)n.string.push(e[u])}if(Y){for(s in n.default)if(r=typeof n.default[s],e=n.alias[s]=n.alias[s]||[],n[r]!==void 0){n[r].push(s);for(c=0;c<e.length;c++)n[r].push(e[c])}}let Z=j?Object.keys(n.alias):[];for(c=0;c<h;c++){if(a=t[c],a==="--"){m._=m._.concat(t.slice(++c));break}for(u=0;u<a.length;u++)if(a.charCodeAt(u)!==45)break;if(u===0)m._.push(a);else if(a.substring(u,u+3)==="no-"){if(r=a.substring(u+3),j&&!~Z.indexOf(r))return n.unknown(a);m[r]=!1}else{for(o=u+1;o<a.length;o++)if(a.charCodeAt(o)===61)break;r=a.substring(u,o),i=a.substring(++o)||(c+1===h||(""+t[c+1]).charCodeAt(0)===45||t[++c]),e=u===2?[r]:r;for(o=0;o<e.length;o++){if(r=e[o],j&&!~Z.indexOf(r))return n.unknown("-".repeat(u)+r);wn(m,r,o+1<e.length||i,n)}}}if(Y){for(s in n.default)if(m[s]===void 0)m[s]=n.default[s]}if(x)for(s in m){e=n.alias[s]||[];while(e.length>0)m[e.shift()]=m[s]}return m}var R=(t)=>t.replace(/[<[].+/,"").trim(),On=(t)=>{let n=/<([^>]+)>/g,s=/\[([^\]]+)\]/g,e=[],a=(m)=>{let c=!1,u=m[1];if(u.startsWith("..."))u=u.slice(3),c=!0;return{required:m[0].startsWith("<"),value:u,variadic:c}},r;while(r=n.exec(t))e.push(a(r));let i;while(i=s.exec(t))e.push(a(i));return e},Cn=(t)=>{let n={alias:{},boolean:[]};for(let[s,e]of t.entries()){if(e.names.length>1)n.alias[e.names[0]]=e.names.slice(1);if(e.isBoolean)if(e.negated){if(!t.some((r,i)=>{return i!==s&&r.names.some((m)=>e.names.includes(m))&&typeof r.required==="boolean"}))n.boolean.push(e.names[0])}else n.boolean.push(e.names[0])}return n},K=(t)=>{return t.sort((n,s)=>{return n.length>s.length?-1:1})[0]},E=(t,n)=>{return t.length>=n?t:`${t}${" ".repeat(n-t.length)}`},kn=(t)=>{return t.replace(/([a-z])-([a-z])/g,(n,s,e)=>{return s+e.toUpperCase()})},Wn=(t,n,s)=>{let e=0,a=n.length,r=t,i;for(;e<a;++e)i=r[n[e]],r=r[n[e]]=e===a-1?s:i!=null?i:!!~n[e+1].indexOf(".")||!(+n[e+1]>-1)?{}:[]},Bn=(t,n)=>{for(let s of Object.keys(n)){let e=n[s];if(e.shouldTransform){if(t[s]=Array.prototype.concat.call([],t[s]),typeof e.transformFunction==="function")t[s]=t[s].map(e.transformFunction)}}},vn=(t)=>{let n=/([^\\\/]+)$/.exec(t);return n?n[1]:""},S=(t)=>{return t.split(".").map((n,s)=>{return s===0?kn(n):n}).join(".")};class A extends Error{constructor(t){super(t);if(this.name=this.constructor.name,typeof Error.captureStackTrace==="function")Error.captureStackTrace(this,this.constructor);else this.stack=new Error(t).stack}}class I{constructor(t,n,s){if(this.rawName=t,this.description=n,this.config=Object.assign({},s),t=t.replace(/\.\*/g,""),this.negated=!1,this.names=R(t).split(",").map((e)=>{let a=e.trim().replace(/^-{1,2}/,"");if(a.startsWith("no-"))this.negated=!0,a=a.replace(/^no-/,"");return S(a)}).sort((e,a)=>e.length>a.length?1:-1),this.name=this.names[this.names.length-1],this.negated&&this.config.default==null)this.config.default=!0;if(t.includes("<"))this.required=!0;else if(t.includes("["))this.required=!1;else this.isBoolean=!0}}var An=process.argv,Mn=`${process.platform}-${process.arch} node-${process.version}`;class G{constructor(t,n,s={},e){this.rawName=t,this.description=n,this.config=s,this.cli=e,this.options=[],this.aliasNames=[],this.name=R(t),this.args=On(t),this.examples=[]}usage(t){return this.usageText=t,this}allowUnknownOptions(){return this.config.allowUnknownOptions=!0,this}ignoreOptionDefaultValue(){return this.config.ignoreOptionDefaultValue=!0,this}version(t,n="-v, --version"){return this.versionNumber=t,this.option(n,"Display version number"),this}example(t){return this.examples.push(t),this}option(t,n,s){let e=new I(t,n,s);return this.options.push(e),this}alias(t){return this.aliasNames.push(t),this}action(t){return this.commandAction=t,this}isMatched(t){return this.name===t||this.aliasNames.includes(t)}get isDefaultCommand(){return this.name===""||this.aliasNames.includes("!")}get isGlobalCommand(){return this instanceof L}hasOption(t){return t=t.split(".")[0],this.options.find((n)=>{return n.names.includes(t)})}outputHelp(){let{name:t,commands:n}=this.cli,{versionNumber:s,options:e,helpCallback:a}=this.cli.globalCommand,r=[{body:`${t}${s?`/${s}`:""}`}];if(r.push({title:"Usage",body:`  $ ${t} ${this.usageText||this.rawName}`}),(this.isGlobalCommand||this.isDefaultCommand)&&n.length>0){let c=K(n.map((u)=>u.rawName));r.push({title:"Commands",body:n.map((u)=>{return`  ${E(u.rawName,c.length)}  ${u.description}`}).join(`
`)}),r.push({title:"For more info, run any command with the `--help` flag",body:n.map((u)=>`  $ ${t}${u.name===""?"":` ${u.name}`} --help`).join(`
`)})}let m=this.isGlobalCommand?e:[...this.options,...e||[]];if(!this.isGlobalCommand&&!this.isDefaultCommand)m=m.filter((c)=>c.name!=="version");if(m.length>0){let c=K(m.map((u)=>u.rawName));r.push({title:"Options",body:m.map((u)=>{return`  ${E(u.rawName,c.length)}  ${u.description} ${u.config.default===void 0?"":`(default: ${u.config.default})`}`}).join(`
`)})}if(this.examples.length>0)r.push({title:"Examples",body:this.examples.map((c)=>{if(typeof c==="function")return c(t);return c}).join(`
`)});if(a)r=a(r)||r;console.log(r.map((c)=>{return c.title?`${c.title}:
${c.body}`:c.body}).join(`

`))}outputVersion(){let{name:t}=this.cli,{versionNumber:n}=this.cli.globalCommand;if(n)console.log(`${t}/${n} ${Mn}`)}checkRequiredArgs(){let t=this.args.filter((n)=>n.required).length;if(this.cli.args.length<t)throw new A(`missing required args for command \`${this.rawName}\``)}checkUnknownOptions(){let{options:t,globalCommand:n}=this.cli;if(!this.config.allowUnknownOptions){for(let s of Object.keys(t))if(s!=="--"&&!this.hasOption(s)&&!n.hasOption(s))throw new A(`Unknown option \`${s.length>1?`--${s}`:`-${s}`}\``)}}checkOptionValue(){let{options:t,globalCommand:n}=this.cli,s=[...n.options,...this.options];for(let e of s){let a=t[e.name.split(".")[0]];if(e.required){let r=s.some((i)=>i.negated&&i.names.includes(e.name));if(a===!0||a===!1&&!r)throw new A(`option \`${e.rawName}\` value is missing`)}}}}class L extends G{constructor(t){super("@@global@@","",{},t)}}var v=Object.assign;class P extends xn{constructor(t=""){super();this.name=t,this.commands=[],this.rawArgs=[],this.args=[],this.options={},this.globalCommand=new L(this),this.globalCommand.usage("<command> [options]")}usage(t){return this.globalCommand.usage(t),this}command(t,n,s){let e=new G(t,n||"",s,this);return e.globalCommand=this.globalCommand,this.commands.push(e),e}option(t,n,s){return this.globalCommand.option(t,n,s),this}help(t){return this.globalCommand.option("-h, --help","Display this message"),this.globalCommand.helpCallback=t,this.showHelpOnExit=!0,this}version(t,n="-v, --version"){return this.globalCommand.version(t,n),this.showVersionOnExit=!0,this}example(t){return this.globalCommand.example(t),this}outputHelp(){if(this.matchedCommand)this.matchedCommand.outputHelp();else this.globalCommand.outputHelp()}outputVersion(){this.globalCommand.outputVersion()}setParsedInfo({args:t,options:n},s,e){if(this.args=t,this.options=n,s)this.matchedCommand=s;if(e)this.matchedCommandName=e;return this}unsetMatchedCommand(){this.matchedCommand=void 0,this.matchedCommandName=void 0}parse(t=An,{run:n=!0}={}){if(this.rawArgs=t,!this.name)this.name=t[1]?vn(t[1]):"cli";let s=!0;for(let a of this.commands){let r=this.mri(t.slice(2),a),i=r.args[0];if(a.isMatched(i)){s=!1;let m=v(v({},r),{args:r.args.slice(1)});this.setParsedInfo(m,a,i),this.emit(`command:${i}`,a)}}if(s){for(let a of this.commands)if(a.name===""){s=!1;let r=this.mri(t.slice(2),a);this.setParsedInfo(r,a),this.emit("command:!",a)}}if(s){let a=this.mri(t.slice(2));this.setParsedInfo(a)}if(this.options.help&&this.showHelpOnExit)this.outputHelp(),n=!1,this.unsetMatchedCommand();if(this.options.version&&this.showVersionOnExit&&this.matchedCommandName==null)this.outputVersion(),n=!1,this.unsetMatchedCommand();let e={args:this.args,options:this.options};if(n)this.runMatchedCommand();if(!this.matchedCommand&&this.args[0])this.emit("command:*");return e}mri(t,n){let s=[...this.globalCommand.options,...n?n.options:[]],e=Cn(s),a=[],r=t.indexOf("--");if(r>-1)a=t.slice(r+1),t=t.slice(0,r);let i=$n(t,e);i=Object.keys(i).reduce((h,x)=>{return v(v({},h),{[S(x)]:i[x]})},{_:[]});let m=i._,c={"--":a},u=n&&n.config.ignoreOptionDefaultValue?n.config.ignoreOptionDefaultValue:this.globalCommand.config.ignoreOptionDefaultValue,o=Object.create(null);for(let h of s){if(!u&&h.config.default!==void 0)for(let x of h.names)c[x]=h.config.default;if(Array.isArray(h.config.type)){if(o[h.name]===void 0)o[h.name]=Object.create(null),o[h.name].shouldTransform=!0,o[h.name].transformFunction=h.config.type[0]}}for(let h of Object.keys(i))if(h!=="_"){let x=h.split(".");Wn(c,x,i[h]),Bn(c,o)}return{args:m,options:c}}runMatchedCommand(){let{args:t,options:n,matchedCommand:s}=this;if(!s||!s.commandAction)return;s.checkUnknownOptions(),s.checkOptionValue(),s.checkRequiredArgs();let e=[];return s.args.forEach((a,r)=>{if(a.variadic)e.push(t.slice(r));else e.push(t[r])}),e.push(n),s.commandAction.apply(this,e)}}var T=(t="")=>new P(t);import{existsSync as M,readdirSync as Nn}from"fs";import{join as g,relative as U,resolve as b}from"path";var{$:l}=globalThis.Bun;function Vn(t=process.cwd()){let n=b(t),s=b("/");while(n!==s){let e=g(n,"package.json"),a=g(n,"turbo.json");if(M(e)&&M(a))return n;n=b(n,"..")}return process.cwd()}function jn(){let t=process.argv.slice(2),n="lint",s="ts",e=!1,a=[];for(let r of t)if(r.startsWith("--check-type="))n=r.split("=")[1];else if(r.startsWith("--lint-type="))s=r.split("=")[1];else if(r==="--fix")e=!0;else if(!r.startsWith("--"))a.push(r);return{config:{checkType:n,lintType:s,isFix:e},files:a}}function qn(t,n){let s=b(n,t),e=U(n,s),a=[/^apps\/([^/]+)/,/^packages\/([^/]+)/,/^tooling\/([^/]+)/,/^testing\/([^/]+)/,/^scripts\/([^/]+)/];for(let r of a){let i=r.exec(e);if(i){let m=i[1];if(m)return m}}return null}function Gn(t,n){switch(t){case"tsp":return[g(n,"packages/api/src/schema/")];case"md":return[g(n,"apps/wiki/docs/")];case"shell":{let s=g(n,".docker"),e=[];try{let a=Nn(s,{recursive:!0}).filter((r)=>r.endsWith(".sh")).map((r)=>g(s,r));e.push(...a)}catch{}return e}case"actions":return[g(n,".github/")];case"textlint":return[g(n,"apps/wiki/docs/")];default:return[g(n,"apps/*/app/"),g(n,"packages/*/src/"),g(n,"tooling/*/src/"),g(n,"testing/*/src/")]}}function Ln(t){let n=t.replace(/\.(ts|tsx)$/,".test.$1");return M(n)?n:null}function Un(t){let n=t.replace(/\.test\.(ts|tsx)$/,".$1");return M(n)?n:null}async function Hn(t,n){let s=b(n,t),e=g(n,"node_modules",".bin","vitest"),a=Ln(s);if(!a)console.error(`Error: Test file not found for ${t}`),process.exit(1);await l`${e} run --coverage --coverage.include=${s} --coverage.threshold.lines=100 --coverage.threshold.functions=100 --coverage.threshold.branches=100 --coverage.threshold.statements=100 ${a}`.cwd(n).env({NODE_ENV:"test",PATH:process.env.PATH||""})}async function _n(t,n,s){if(n!=="ts")console.error(`Error: --lint-type=${n} is not supported for test. Only --lint-type=ts is supported.`),process.exit(1);let e=t.map((r)=>b(s,r)),a=g(s,"node_modules",".bin","vitest");await l`${a} run ${e}`.cwd(s).env({NODE_ENV:"test",PATH:process.env.PATH||""})}async function zn(t,n,s){if(n!=="ts")console.error(`Error: --lint-type=${n} is not supported for coverage. Only --lint-type=ts is supported.`),process.exit(1);let e=g(s,"node_modules",".bin","vitest");if(t.length>0){let a=t.map((r)=>{let i=b(s,r);if(r.includes(".test."))return Un(i);return i}).filter((r)=>r!==null);if(a.length===0)console.error("Error: No source files found"),process.exit(1);for(let r of a)await Hn(U(s,r),s);return}await l`${e} run --coverage`.cwd(s).env({NODE_ENV:"test",PATH:process.env.PATH||""})}async function yn(t,n,s,e,a){let r=e.map((i)=>b(a,i));if(n==="fmt"){if(s)await l`${t} format ${r}`.cwd(a);else await l`${t} format --check ${r}`.cwd(a);return}if(s)await l`${t} compile ${r}`.cwd(a);else await l`${t} compile ${r} --warn-as-error`.cwd(a)}function Jn(t,n){if(t==="fmt")return n?"fmt":"fmt:check";return n?"lint:fix":"lint"}async function Qn(t,n,s,e){if(t.size===0)return;let r=Array.from(t).map((m)=>`--filter=${m}`).join(" "),i=Jn(n,s);await l`turbo run ${i} ${r}`.cwd(e)}async function Yn(t,n,s,e,a){if(e.length===0)return;if(n==="fmt")if(s)await l`${t} check --write --only=formatter --organize-imports-enabled=true ${e}`.cwd(a);else await l`${t} check --only=formatter --organize-imports-enabled=true ${e}`.cwd(a);else if(s)await l`${t} check --write --only=linter --organize-imports-enabled=true ${e}`.cwd(a);else await l`${t} check --only=linter --organize-imports-enabled=true ${e}`.cwd(a)}async function Zn(t,n,s,e,a){let r=new Set,i=[];for(let m of e){let c=b(a,m),u=qn(c,a);if(u)r.add(u);else i.push(c)}await Qn(r,n,s,a),await Yn(t,n,s,i,a)}async function Xn(t,n,s,e){let a=s.map((i)=>b(e,i));if(t==="fmt"){if(n)await l`remark ${a} --output`.cwd(e);else await l`remark ${a} --frail --quiet`.cwd(e);return}let r=g(e,"node_modules",".bin","markdownlint-cli2");if(n)await l`${r} --fix ${a}`.cwd(e);else await l`${r} ${a}`.cwd(e)}async function Kn(t,n,s,e){let a=s.map((i)=>b(e,i));if(a.length===0){console.log("No shell files to check");return}if(t==="fmt"){if(n)await l`go run mvdan.cc/sh/v3/cmd/shfmt@v3.12.0 -w ${a}`.cwd(e);else await l`go run mvdan.cc/sh/v3/cmd/shfmt@v3.12.0 -l -d ${a}`.cwd(e);return}let r=a.map((i)=>U(e,i));await l`docker run --rm -v ${e}:/work -w /work -v ${e}/node_modules:/work/node_modules koalaman/shellcheck:v0.11.0 ${r}`}async function En(t,n,s,e){if(t==="fmt")console.error("Error: textlint does not support formatting. Use --check-type=lint instead."),process.exit(1);let a=s.map((i)=>b(e,i)),r=g(e,"node_modules",".bin","textlint");if(n)await l`${r} --fix ${a}`.cwd(e);else await l`${r} ${a}`.cwd(e)}async function Rn(t,n,s,e){if(t==="fmt"){let u=n?[]:["-lint"];u.push("-gitignore_excludes",...s);let o=Bun.spawn(["go","run","github.com/google/yamlfmt/cmd/yamlfmt@v0.20.0",...u],{stdout:"inherit",stderr:"inherit"});if(await o.exited,o.exitCode!==0)process.exit(o.exitCode||1);return}let a=Bun.spawn(["go","run","github.com/rhysd/actionlint/cmd/actionlint@v1.7.9"],{stdout:"inherit",stderr:"inherit"}),r=["go","run","github.com/suzuki-shunsuke/ghalint/cmd/ghalint@v1.5.4","run",...s],i=Bun.spawn(r,{stdout:"inherit",stderr:"inherit"}),[m,c]=await Promise.all([a.exited.then(()=>a.exitCode),i.exited.then(()=>i.exitCode)]);if(m!==0||c!==0)process.exit(1)}async function Sn(t,n,s){let{checkType:e,lintType:a}=t,r=g(s,"node_modules",".bin");switch(a){case"tsp":{let i=g(r,"tsp");await yn(i,e,t.isFix,n,s);break}case"md":{await Xn(e,t.isFix,n,s);break}case"shell":{await Kn(e,t.isFix,n,s);break}case"actions":{await Rn(e,t.isFix,n,s);break}case"textlint":{await En(e,t.isFix,n,s);break}default:{let i=g(r,"biome");await Zn(i,e,t.isFix,n,s)}}}async function F(){let t=Vn(),{config:n,files:s}=jn();try{if(n.checkType==="coverage")await zn(s,n.lintType,t);else if(n.checkType==="test")await _n(s,n.lintType,t);else{let e=Gn(n.lintType,t),a=s.length>0?s:e;await Sn(n,a,t)}process.exit(0)}catch{process.exit(1)}}var z=B(C(),1);import{existsSync as _,readFileSync as Dn}from"fs";import{dirname as nt,join as y,relative as tn,resolve as W}from"path";var p=B(C(),1);function d(t,n,s="info"){let e={info:p.default.blue,success:p.default.green,warning:p.default.yellow,error:p.default.red},a;if(s==="success")a="\u2713";else if(s==="error")a="\u2717";else if(s==="warning")a="\u26A0";else a="\u2192";console.log(`  ${e[s](a)} ${t} ${n}`)}function Fn(t,n="info"){let s={info:p.default.dim,success:p.default.green,warning:p.default.yellow},e;if(n==="success")e="\u2713";else if(n==="warning")e="\u26A0";else e="  ";console.log(`    ${s[n](e)} ${t}`)}class k{message;interval=null;frames=["\u280B","\u2819","\u2839","\u2838","\u283C","\u2834","\u2826","\u2827","\u2807","\u280F"];frameIndex=0;isActive=!1;constructor(t){this.message=t}start(){if(this.isActive)return;this.isActive=!0,this.frameIndex=0,this.interval=setInterval(()=>{let t=this.frames[this.frameIndex%this.frames.length];process.stdout.write(`\r    ${p.default.cyan(t)} ${p.default.dim(this.message)}`),this.frameIndex++},100)}stop(t=!0,n){if(!this.isActive)return;if(this.isActive=!1,this.interval)clearInterval(this.interval),this.interval=null;if(process.stdout.write(`\r${" ".repeat(80)}\r`),n)Fn(n,t?"success":"warning")}}function $(t=process.cwd()){let n=W(t),s=W("/");while(n!==s){let e=y(n,"package.json");if(_(e))return n;n=W(n,"..")}return process.cwd()}function J(t,n){if(!_(t))return null;let s=nt(t);while(s.startsWith(n)){let e=y(s,"package.json");if(_(e))return s;if(s===n)break;s=W(s,"..")}return null}function tt(t,n){try{let s=y(t,"package.json"),e=Dn(s,"utf-8"),a=JSON.parse(e);return Boolean(a.scripts?.[n])}catch{return!1}}function en(t,n){let s=new Map;for(let e of t){let a=e.startsWith("/")?e:W(n,e),r=J(a,n);if(!r){d("\u26A0\uFE0F",`Skipping ${e}: no package.json found`,"warning");continue}let i=tn(n,r)||"root",m=tn(r,a);if(!s.has(r))s.set(r,{dir:r,name:i,files:[]});s.get(r).files.push(m)}return s}async function sn(t,n,s){if(!tt(t.dir,n))return d("\u26A0\uFE0F",`${t.name}: script "${n}" not found`,"warning"),{success:!1,skipped:!0};let e=new k(`Running ${n} in ${t.name}...`);e.start();try{let a=Bun.spawn(["bun","run",n,"--",...t.files],{cwd:t.dir,stdout:"pipe",stderr:"pipe"}),r=await a.exited;if(e.stop(r===0,`${t.name}: ${n} ${r===0?"completed":"failed"}`),r!==0){let i=await new Response(a.stderr).text();if(i)console.error(z.default.red(`
Error in ${t.name}:`)),console.error(i);return{success:!1,skipped:!1,exitCode:r}}return{success:!0,skipped:!1}}catch(a){return e.stop(!1,`${t.name}: ${n} failed`),console.error(z.default.red(`
Error in ${t.name}:`),a),{success:!1,skipped:!1}}}async function an(t,n,s,e=!0){if(t.size===0)return d("\u2139\uFE0F","No packages to process","info"),!0;let a=Array.from(t.values());if(e){let r=await Promise.all(a.map((c)=>sn(c,n,s))),i=r.map((c,u)=>({result:c,package:a[u]})).filter((c)=>c.result.success&&c.package!==void 0).map(({package:c})=>c.name),m=r.some((c)=>!c.success&&!c.skipped);if(i.length>0)d("\u2713",`Processed ${i.length} package(s): ${i.join(", ")}`,"success");return!m}else{let r=!1,i=[];for(let m of a){let c=await sn(m,n,s);if(c.success)i.push(m.name);else if(!c.skipped)r=!0}if(i.length>0)d("\u2713",`Processed ${i.length} package(s): ${i.join(", ")}`,"success");return!r}}import{existsSync as st}from"fs";import{join as et}from"path";async function rn(){let t=$(process.cwd()),n=et(t,"infra","scripts","verify.ts");if(!st(n))return console.error("[check infra] verify script not found:",n),!1;return await Bun.spawn(["bun","run",n],{cwd:t,stdio:"inherit"}).exited===0}var f=B(C(),1);import{execSync as at}from"child_process";import{existsSync as rt,readFileSync as it}from"fs";var ct=[/^infra\/Pulumi\..*\.yaml$/,/\.env$/,/\.env\.local$/,/\.env\..*$/,/^\.git\/config$/,/^\.git\/credentials$/],cn=[/doppler:dopplerToken/i,/secure:/i,/api[_-]?key/i,/apikey/i,/password/i,/passwd/i,/pwd/i,/token/i,/access[_-]?token/i,/refresh[_-]?token/i,/secret/i,/secret[_-]?key/i,/credential/i,/credentials/i,/auth/i,/aws[_-]?access[_-]?key/i,/aws[_-]?secret[_-]?key/i,/private[_-]?key/i,/public[_-]?key/i,/bearer[_-]?token/i,/session[_-]?id/i,/session[_-]?secret/i],mn=[/^[A-Za-z0-9+/]{32,}={0,2}$/,/^[A-Za-z0-9_-]{20,}$/,/^sk-[A-Za-z0-9_-]+$/,/^pk_[A-Za-z0-9_-]+$/,/^ghp_[A-Za-z0-9_-]+$/,/^gho_[A-Za-z0-9_-]+$/,/^ghu_[A-Za-z0-9_-]+$/,/^ghs_[A-Za-z0-9_-]+$/,/^ghr_[A-Za-z0-9_-]+$/,/^AKIA[0-9A-Z]{16}$/,/^AIza[0-9A-Za-z_-]{35}$/,/^ya29\.[0-9A-Za-z_-]+$/,/^xox[baprs]-[0-9a-zA-Z-]{10,48}$/],mt=[/\.example$/,/\.sample$/,/\.template$/,/\.dist$/,/node_modules/,/\.git/,/dist/,/build/,/coverage/,/\.turbo/];function ut(){try{return at("git diff --cached --name-only --diff-filter=ACM",{encoding:"utf-8"}).split(`
`).map((n)=>n.trim()).filter((n)=>n.length>0)}catch(t){return console.error("Error getting staged files:",t),[]}}function ot(t){if(mt.some((n)=>n.test(t)))return!1;return ct.some((n)=>n.test(t))}function lt(t){let n=[];if(t.includes("doppler:dopplerToken"))n.push("contains 'doppler:dopplerToken' - use DOPPLER_TOKEN environment variable instead");if(/^\s*secure:/m.test(t))n.push("contains encrypted secrets (secure:) - use environment variables instead");return n}function gt(t){let n=[],s=t.split(`
`);for(let e=0;e<s.length;e++){let a=s[e]?.trim();if(!a||a.startsWith("#")||a.length===0)continue;let r=a.split("=");if(r.length<2)continue;let i=r[0]?.trim();if(!i)continue;let m=r.slice(1).join("=").trim().replaceAll(/(?:^["'])|(?:["']$)/g,"");if(!cn.some((c)=>c.test(i)))continue;if(m.length===0||m==="null"||m==="undefined"||m==="''"||m==='""')continue;if(mn.some((c)=>c.test(m)))n.push(`line ${e+1}: potential secret in '${i}'`);else if(m.length>10)n.push(`line ${e+1}: potential secret in '${i}' (long value detected)`)}return n}function ht(t){let n=[];for(let s of cn){let e=new RegExp(`(${s.source})\\s*[:=]\\s*["']?([^"'
]{10,})["']?`,"gi"),a=t.matchAll(e);for(let r of a){let i=r[2];if(i&&mn.some((m)=>m.test(i)))n.push(`potential hardcoded secret detected: '${r[1]}'`)}}return n}function dt(t){if(!rt(t))return{found:!1,issues:[]};let n=it(t,"utf-8"),s=[];if(/^infra\/Pulumi\..*\.yaml$/.test(t))s.push(...lt(n));else if(/\.env/.test(t))s.push(...gt(n));else s.push(...ht(n));return{found:s.length>0,issues:s}}function ft(t){for(let{file:n,issues:s}of t){d("\u274C",n,"error");for(let e of s)console.error(f.default.red(`   ${e}`));console.error()}}function bt(){console.error(),d("\uD83D\uDCA1","Security best practices:","info"),console.error(f.default.dim("   \u2022 Use environment variables instead of hardcoding secrets")),console.error(f.default.dim("   \u2022 Never commit .env files with actual secrets")),console.error(f.default.dim("   \u2022 Use .env.example files for documentation")),console.error(f.default.dim("   \u2022 Use secret management services (e.g., Doppler, AWS Secrets Manager)")),console.error()}function pt(){console.error(f.default.yellow("   For Pulumi config files:")),console.error(f.default.dim("   \u2022 Remove 'doppler:dopplerToken' from config files")),console.error(f.default.dim("   \u2022 Use DOPPLER_TOKEN environment variable instead")),console.error(f.default.dim("   \u2022 See infra/README.md for details")),console.error()}function xt(){console.error(f.default.yellow("   For .env files:")),console.error(f.default.dim("   \u2022 Add .env files to .gitignore")),console.error(f.default.dim("   \u2022 Use .env.example for documentation")),console.error(f.default.dim("   \u2022 Never commit actual secrets")),console.error()}function wt(t){if(console.error(),d("\u274C","Security issues detected:","error"),console.error(),ft(t),bt(),t.filter(({file:e})=>/^infra\/Pulumi\..*\.yaml$/.test(e)).length>0)pt();if(t.filter(({file:e})=>/\.env/.test(e)).length>0)xt()}async function un(t){let n=t&&t.length>0?t:ut();if(n.length===0)return d("\u2139\uFE0F","No files to check","info"),!0;let s=n.filter(ot);if(s.length===0)return d("\u2139\uFE0F","No security-sensitive files to check","info"),!0;let e=[];for(let a of s){let{found:r,issues:i}=dt(a);if(r)e.push({file:a,issues:i})}if(e.length>0)return wt(e),!1;return d("\u2713","No security issues detected","success"),!0}var ln=B(C(),1);import{execSync as $t}from"child_process";import{existsSync as Ot}from"fs";import{join as O,resolve as Ct}from"path";var{$:kt}=globalThis.Bun;function Q(t,n){let s=t.startsWith("/")?t:Ct(n,t),e=J(s,n);if(!e)return null;return e.replace(`${n}/`,"")}function Wt(t,n){return t.map((s)=>s.startsWith("/")?s.replace(`${n}/`,""):s).filter((s)=>!s.includes("worker-configuration.d.ts")&&!s.includes("/.astro/")&&!s.includes("/.turbo/")&&!s.includes("/.tanstack/")&&!s.includes("/.wrangler/")&&!s.includes("/build/")&&!s.includes("/dist/")&&!s.includes("/report/")&&!s.includes("/coverage/"))}function Bt(t){return t.filter((n)=>!n.endsWith(".test.ts")&&!n.endsWith(".test.tsx")&&(n.endsWith(".ts")||n.endsWith(".tsx")))}function vt(t,n){return t.filter((s)=>{let a=(s.startsWith("/")?s:`${n}/${s}`).replace(/\.(ts|tsx)$/,".test.$1");return Ot(a)})}function At(t,n){let s=new Map,e=[];for(let a of t){let r=a.startsWith("/")?a.replace(`${n}/`,""):a,i=Q(r,n);if(i){if(!s.has(i))s.set(i,[]);s.get(i).push(r)}else e.push(r)}return{workspaceGroups:s,rootFiles:e}}function Mt(t,n,s){for(let[e]of t)s.push(`cd ${O(n,e)} && bun run fmt:check && bun run lint`)}function Nt(t,n,s){if(t.length===0)return;if(t.filter((a)=>a.endsWith(".ts")||a.endsWith(".tsx")||a.endsWith(".js")||a.endsWith(".jsx")).length>0)s.push(`cd ${n} && bunx turbo run fmt:check`,`cd ${n} && bunx turbo run lint`)}function Vt(t,n,s){for(let e of t){let a=e.startsWith("/")?e.replace(`${n}/`,""):e,r=Q(a,n),i=a.replace(/\.(ts|tsx)$/,".test.$1");if(r){let m=O(n,r),c=i.replace(`${r}/`,""),u=a.replace(`${r}/`,"");s.push(`cd ${m} && bun run test -- ${c}`,`cd ${m} && bun run coverage -- ${u}`)}}}function on(t,n){let s=Wt(t,n),e=Bt(s),a=vt(e,n),r=s.some((u)=>u.endsWith(".ts")||u.endsWith(".tsx")),{workspaceGroups:i,rootFiles:m}=At(s,n),c=[];if(Mt(i,n,c),Nt(m,n,c),Vt(a,n,c),r)c.push(`cd ${n} && bunx turbo run typecheck`);return c}function jt(t,n){if(n==="*.{ts,tsx}")return t.endsWith(".ts")||t.endsWith(".tsx");if(n==="*.config.js")return t.endsWith(".config.js");if(n==="*.md")return t.endsWith(".md");if(n==="*.sh")return t.endsWith(".sh");if(n==="*.tsp")return t.endsWith(".tsp");if(n==="**/*.test.{ts,tsx}")return t.includes(".test.ts")||t.includes(".test.tsx");if(n.startsWith(".github/")&&n.endsWith("/*.yml"))return t.startsWith(".github/")&&t.endsWith(".yml");return!1}function qt(){try{return $t("git diff --cached --name-only --diff-filter=ACM",{encoding:"utf-8"}).split(`
`).map((n)=>n.trim()).filter((n)=>n.length>0)}catch(t){return console.error("Error getting staged files:",t),[]}}async function Gt(t){try{return await kt`sh -c ${t}`,!0}catch{return!1}}function Lt(t,n){if(!Array.isArray(t)||t.length===0)return[];let s={".github/**/*.yml":(a)=>a.flatMap((r)=>[`bun run fmt:actions:check -- ${r}`,`bun run lint:actions:check -- ${r}`]),"*.{ts,tsx}":(a)=>on(a,n),"*.config.js":(a)=>on(a,n),"*.md":(a)=>{let r=a.filter((c)=>c.includes("apps/wiki/")),i=a.filter((c)=>!c.includes("apps/wiki/")),m=[];if(r.length>0){let c=r.map((u)=>{let o=u.match(/apps\/wiki\/(.+)/);return o?o[1]:u});m.push(`cd ${O(n,"apps/wiki")} && bun run fmt:md:check -- ${c.join(" ")}`,`cd ${O(n,"apps/wiki")} && bun run lint:md:check -- ${c.join(" ")}`,`cd ${O(n,"apps/wiki")} && bun run lint:textlint:check -- ${c.join(" ")}`)}if(i.length>0)d("\u26A0\uFE0F",`The following markdown files are outside apps/wiki/ and will not be checked: ${i.join(", ")}`,"warning");return m},"*.sh":(a)=>a.flatMap((r)=>[`bun run fmt:shell:check -- ${r}`,`bun run lint:shell:check -- ${r}`]),"*.tsp":(a)=>a.flatMap((r)=>[`bun run fmt:tsp:check -- ${r}`,`bun run lint:tsp:check -- ${r}`]),"**/*.test.{ts,tsx}":(a)=>{let r=[];for(let i of a){let m=i.startsWith("/")?i.replace(`${n}/`,""):i,c=Q(m,n);if(c){let u=O(n,c),o=m.replace(`${c}/`,"");r.push(`cd ${u} && bun run test -- ${o}`)}else d("\u26A0\uFE0F",`Test file ${m} is not in a workspace directory and will be skipped`,"warning")}return r}},e=[];for(let[a,r]of Object.entries(s)){let i=t.filter((m)=>jt(m,a));if(i.length>0){let m=r(i);e.push(...m)}}return e}async function gn(t){let n=$(),s=t&&t.length>0?t:qt();if(s.length===0)return d("\u2139\uFE0F","No files to process","info"),!0;let e=Lt(s,n);if(e.length===0)return d("\u2139\uFE0F","No commands to execute","info"),!0;let a=!1;for(let r of e){let i=new k(`Running: ${r}`);i.start();let m=await Gt(r);if(i.stop(m,m?`Completed: ${r}`:`Failed: ${r}`),!m)a=!0,console.error(ln.default.red(`Command failed: ${r}`))}return!a}var w=T("check");w.command("staged","\u30B9\u30C6\u30FC\u30B8\u3055\u308C\u305F\u30D5\u30A1\u30A4\u30EB\u3092\u30C1\u30A7\u30C3\u30AF\u3057\u307E\u3059").option("--files <files...>","\u30C1\u30A7\u30C3\u30AF\u3059\u308B\u30D5\u30A1\u30A4\u30EB\u306E\u30EA\u30B9\u30C8").action(async(t)=>{let n=[];if(Array.isArray(t.files))n=t.files;else if(t.files)n=[t.files];let s=await gn(n.length>0?n:void 0);process.exit(s?0:1)});w.command("secrets","\u30BB\u30AD\u30E5\u30EA\u30C6\u30A3\u95A2\u9023\u306E\u30B7\u30FC\u30AF\u30EC\u30C3\u30C8\u3092\u7DB2\u7F85\u7684\u306B\u30C1\u30A7\u30C3\u30AF\u3057\u307E\u3059").option("--files <files...>","\u30C1\u30A7\u30C3\u30AF\u3059\u308B\u30D5\u30A1\u30A4\u30EB\u306E\u30EA\u30B9\u30C8").action(async(t)=>{let n=t.files||[],s=await un(n.length>0?n:void 0);process.exit(s?0:1)});w.command("infra","infra \u7528 API \u30AD\u30FC\u30FB\u30C8\u30FC\u30AF\u30F3\u306E\u6709\u52B9\u6027\u3092\u691C\u8A3C\u3057\u307E\u3059\uFF08.env \u3092\u53C2\u7167\uFF09").action(async()=>{let t=await rn();process.exit(t?0:1)});w.command("dispatch <command>","\u30D1\u30C3\u30B1\u30FC\u30B8\u3054\u3068\u306B\u30B3\u30DE\u30F3\u30C9\u3092\u5B9F\u884C\u3057\u307E\u3059").option("--files <files...>","\u51E6\u7406\u3059\u308B\u30D5\u30A1\u30A4\u30EB\u306E\u30EA\u30B9\u30C8").option("--no-parallel","\u4E26\u5217\u5B9F\u884C\u3092\u7121\u52B9\u5316").action(async(t,n)=>{let s=$(),e=n.files||[];if(e.length===0)console.error("Error: No files provided"),process.exit(1);let a=en(e,s),r=await an(a,t,s,!n["no-parallel"]);process.exit(r?0:1)});w.command("*","\u65E2\u5B58\u306Echeck\u30B3\u30DE\u30F3\u30C9\u3092\u5B9F\u884C\u3057\u307E\u3059").action(async()=>{await F()});w.help();w.version("1.0.1");w.parse();
