#!/usr/bin/env bun
// @bun
var de=Object.create;var{getPrototypeOf:ge,defineProperty:H,getOwnPropertyNames:fe}=Object;var he=Object.prototype.hasOwnProperty;var C=(n,e,s)=>{s=n!=null?de(ge(n)):{};let t=e||!n||!n.__esModule?H(s,"default",{value:n,enumerable:!0}):s;for(let i of fe(n))if(!he.call(t,i))H(t,i,{get:()=>n[i],enumerable:!0});return t};var pe=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports);var v=pe((Pn,V)=>{var B=process||{},D=B.argv||[],E=B.env||{},Je=!(!!E.NO_COLOR||D.includes("--no-color"))&&(!!E.FORCE_COLOR||D.includes("--color")||B.platform==="win32"||(B.stdout||{}).isTTY&&E.TERM!=="dumb"||!!E.CI),Qe=(n,e,s=n)=>(t)=>{let i=""+t,r=i.indexOf(e,n.length);return~r?n+Xe(i,e,s,r)+e:n+i+e},Xe=(n,e,s,t)=>{let i="",r=0;do i+=n.substring(r,t)+s,r=t+e.length,t=n.indexOf(e,r);while(~t);return i+n.substring(r)},ee=(n=Je)=>{let e=n?Qe:()=>String;return{isColorSupported:n,reset:e("\x1B[0m","\x1B[0m"),bold:e("\x1B[1m","\x1B[22m","\x1B[22m\x1B[1m"),dim:e("\x1B[2m","\x1B[22m","\x1B[22m\x1B[2m"),italic:e("\x1B[3m","\x1B[23m"),underline:e("\x1B[4m","\x1B[24m"),inverse:e("\x1B[7m","\x1B[27m"),hidden:e("\x1B[8m","\x1B[28m"),strikethrough:e("\x1B[9m","\x1B[29m"),black:e("\x1B[30m","\x1B[39m"),red:e("\x1B[31m","\x1B[39m"),green:e("\x1B[32m","\x1B[39m"),yellow:e("\x1B[33m","\x1B[39m"),blue:e("\x1B[34m","\x1B[39m"),magenta:e("\x1B[35m","\x1B[39m"),cyan:e("\x1B[36m","\x1B[39m"),white:e("\x1B[37m","\x1B[39m"),gray:e("\x1B[90m","\x1B[39m"),bgBlack:e("\x1B[40m","\x1B[49m"),bgRed:e("\x1B[41m","\x1B[49m"),bgGreen:e("\x1B[42m","\x1B[49m"),bgYellow:e("\x1B[43m","\x1B[49m"),bgBlue:e("\x1B[44m","\x1B[49m"),bgMagenta:e("\x1B[45m","\x1B[49m"),bgCyan:e("\x1B[46m","\x1B[49m"),bgWhite:e("\x1B[47m","\x1B[49m"),blackBright:e("\x1B[90m","\x1B[39m"),redBright:e("\x1B[91m","\x1B[39m"),greenBright:e("\x1B[92m","\x1B[39m"),yellowBright:e("\x1B[93m","\x1B[39m"),blueBright:e("\x1B[94m","\x1B[39m"),magentaBright:e("\x1B[95m","\x1B[39m"),cyanBright:e("\x1B[96m","\x1B[39m"),whiteBright:e("\x1B[97m","\x1B[39m"),bgBlackBright:e("\x1B[100m","\x1B[49m"),bgRedBright:e("\x1B[101m","\x1B[49m"),bgGreenBright:e("\x1B[102m","\x1B[49m"),bgYellowBright:e("\x1B[103m","\x1B[49m"),bgBlueBright:e("\x1B[104m","\x1B[49m"),bgMagentaBright:e("\x1B[105m","\x1B[49m"),bgCyanBright:e("\x1B[106m","\x1B[49m"),bgWhiteBright:e("\x1B[107m","\x1B[49m")}};V.exports=ee();V.exports.createColors=ee});import{EventEmitter as be}from"events";function R(n){return n==null?[]:Array.isArray(n)?n:[n]}function xe(n,e,s,t){var i,r=n[e],a=~t.string.indexOf(e)?s==null||s===!0?"":String(s):typeof s==="boolean"?s:~t.boolean.indexOf(e)?s==="false"?!1:s==="true"||(n._.push((i=+s,i*0===0)?i:s),!!s):(i=+s,i*0===0)?i:s;n[e]=r==null?a:Array.isArray(r)?r.concat(a):[r,a]}function $e(n,e){n=n||[],e=e||{};var s,t,i,r,a,c={_:[]},o=0,l=0,u=0,g=n.length;let x=e.alias!==void 0,W=e.unknown!==void 0,G=e.default!==void 0;if(e.alias=e.alias||{},e.string=R(e.string),e.boolean=R(e.boolean),x)for(s in e.alias){t=e.alias[s]=R(e.alias[s]);for(o=0;o<t.length;o++)(e.alias[t[o]]=t.concat(s)).splice(o,1)}for(o=e.boolean.length;o-- >0;){t=e.alias[e.boolean[o]]||[];for(l=t.length;l-- >0;)e.boolean.push(t[l])}for(o=e.string.length;o-- >0;){t=e.alias[e.string[o]]||[];for(l=t.length;l-- >0;)e.string.push(t[l])}if(G){for(s in e.default)if(r=typeof e.default[s],t=e.alias[s]=e.alias[s]||[],e[r]!==void 0){e[r].push(s);for(o=0;o<t.length;o++)e[r].push(t[o])}}let q=W?Object.keys(e.alias):[];for(o=0;o<g;o++){if(i=n[o],i==="--"){c._=c._.concat(n.slice(++o));break}for(l=0;l<i.length;l++)if(i.charCodeAt(l)!==45)break;if(l===0)c._.push(i);else if(i.substring(l,l+3)==="no-"){if(r=i.substring(l+3),W&&!~q.indexOf(r))return e.unknown(i);c[r]=!1}else{for(u=l+1;u<i.length;u++)if(i.charCodeAt(u)===61)break;r=i.substring(l,u),a=i.substring(++u)||(o+1===g||(""+n[o+1]).charCodeAt(0)===45||n[++o]),t=l===2?[r]:r;for(u=0;u<t.length;u++){if(r=t[u],W&&!~q.indexOf(r))return e.unknown("-".repeat(l)+r);xe(c,r,u+1<t.length||a,e)}}}if(G){for(s in e.default)if(c[s]===void 0)c[s]=e.default[s]}if(x)for(s in c){t=e.alias[s]||[];while(t.length>0)c[t.shift()]=c[s]}return c}var Y=(n)=>n.replace(/[<[].+/,"").trim(),we=(n)=>{let e=/<([^>]+)>/g,s=/\[([^\]]+)\]/g,t=[],i=(c)=>{let o=!1,l=c[1];if(l.startsWith("..."))l=l.slice(3),o=!0;return{required:c[0].startsWith("<"),value:l,variadic:o}},r;while(r=e.exec(n))t.push(i(r));let a;while(a=s.exec(n))t.push(i(a));return t},ke=(n)=>{let e={alias:{},boolean:[]};for(let[s,t]of n.entries()){if(t.names.length>1)e.alias[t.names[0]]=t.names.slice(1);if(t.isBoolean)if(t.negated){if(!n.some((r,a)=>{return a!==s&&r.names.some((c)=>t.names.includes(c))&&typeof r.required==="boolean"}))e.boolean.push(t.names[0])}else e.boolean.push(t.names[0])}return e},P=(n)=>{return n.sort((e,s)=>{return e.length>s.length?-1:1})[0]},K=(n,e)=>{return n.length>=e?n:`${n}${" ".repeat(e-n.length)}`},ve=(n)=>{return n.replace(/([a-z])-([a-z])/g,(e,s,t)=>{return s+t.toUpperCase()})},ye=(n,e,s)=>{let t=0,i=e.length,r=n,a;for(;t<i;++t)a=r[e[t]],r=r[e[t]]=t===i-1?s:a!=null?a:!!~e[t+1].indexOf(".")||!(+e[t+1]>-1)?{}:[]},Ae=(n,e)=>{for(let s of Object.keys(e)){let t=e[s];if(t.shouldTransform){if(n[s]=Array.prototype.concat.call([],n[s]),typeof t.transformFunction==="function")n[s]=n[s].map(t.transformFunction)}}},Ce=(n)=>{let e=/([^\\\/]+)$/.exec(n);return e?e[1]:""},J=(n)=>{return n.split(".").map((e,s)=>{return s===0?ve(e):e}).join(".")};class O extends Error{constructor(n){super(n);if(this.name=this.constructor.name,typeof Error.captureStackTrace==="function")Error.captureStackTrace(this,this.constructor);else this.stack=new Error(n).stack}}class Q{constructor(n,e,s){if(this.rawName=n,this.description=e,this.config=Object.assign({},s),n=n.replace(/\.\*/g,""),this.negated=!1,this.names=Y(n).split(",").map((t)=>{let i=t.trim().replace(/^-{1,2}/,"");if(i.startsWith("no-"))this.negated=!0,i=i.replace(/^no-/,"");return J(i)}).sort((t,i)=>t.length>i.length?1:-1),this.name=this.names[this.names.length-1],this.negated&&this.config.default==null)this.config.default=!0;if(n.includes("<"))this.required=!0;else if(n.includes("["))this.required=!1;else this.isBoolean=!0}}var _e=process.argv,Oe=`${process.platform}-${process.arch} node-${process.version}`;class N{constructor(n,e,s={},t){this.rawName=n,this.description=e,this.config=s,this.cli=t,this.options=[],this.aliasNames=[],this.name=Y(n),this.args=we(n),this.examples=[]}usage(n){return this.usageText=n,this}allowUnknownOptions(){return this.config.allowUnknownOptions=!0,this}ignoreOptionDefaultValue(){return this.config.ignoreOptionDefaultValue=!0,this}version(n,e="-v, --version"){return this.versionNumber=n,this.option(e,"Display version number"),this}example(n){return this.examples.push(n),this}option(n,e,s){let t=new Q(n,e,s);return this.options.push(t),this}alias(n){return this.aliasNames.push(n),this}action(n){return this.commandAction=n,this}isMatched(n){return this.name===n||this.aliasNames.includes(n)}get isDefaultCommand(){return this.name===""||this.aliasNames.includes("!")}get isGlobalCommand(){return this instanceof M}hasOption(n){return n=n.split(".")[0],this.options.find((e)=>{return e.names.includes(n)})}outputHelp(){let{name:n,commands:e}=this.cli,{versionNumber:s,options:t,helpCallback:i}=this.cli.globalCommand,r=[{body:`${n}${s?`/${s}`:""}`}];if(r.push({title:"Usage",body:`  $ ${n} ${this.usageText||this.rawName}`}),(this.isGlobalCommand||this.isDefaultCommand)&&e.length>0){let o=P(e.map((l)=>l.rawName));r.push({title:"Commands",body:e.map((l)=>{return`  ${K(l.rawName,o.length)}  ${l.description}`}).join(`
`)}),r.push({title:"For more info, run any command with the `--help` flag",body:e.map((l)=>`  $ ${n}${l.name===""?"":` ${l.name}`} --help`).join(`
`)})}let c=this.isGlobalCommand?t:[...this.options,...t||[]];if(!this.isGlobalCommand&&!this.isDefaultCommand)c=c.filter((o)=>o.name!=="version");if(c.length>0){let o=P(c.map((l)=>l.rawName));r.push({title:"Options",body:c.map((l)=>{return`  ${K(l.rawName,o.length)}  ${l.description} ${l.config.default===void 0?"":`(default: ${l.config.default})`}`}).join(`
`)})}if(this.examples.length>0)r.push({title:"Examples",body:this.examples.map((o)=>{if(typeof o==="function")return o(n);return o}).join(`
`)});if(i)r=i(r)||r;console.log(r.map((o)=>{return o.title?`${o.title}:
${o.body}`:o.body}).join(`

`))}outputVersion(){let{name:n}=this.cli,{versionNumber:e}=this.cli.globalCommand;if(e)console.log(`${n}/${e} ${Oe}`)}checkRequiredArgs(){let n=this.args.filter((e)=>e.required).length;if(this.cli.args.length<n)throw new O(`missing required args for command \`${this.rawName}\``)}checkUnknownOptions(){let{options:n,globalCommand:e}=this.cli;if(!this.config.allowUnknownOptions){for(let s of Object.keys(n))if(s!=="--"&&!this.hasOption(s)&&!e.hasOption(s))throw new O(`Unknown option \`${s.length>1?`--${s}`:`-${s}`}\``)}}checkOptionValue(){let{options:n,globalCommand:e}=this.cli,s=[...e.options,...this.options];for(let t of s){let i=n[t.name.split(".")[0]];if(t.required){let r=s.some((a)=>a.negated&&a.names.includes(t.name));if(i===!0||i===!1&&!r)throw new O(`option \`${t.rawName}\` value is missing`)}}}}class M extends N{constructor(n){super("@@global@@","",{},n)}}var _=Object.assign;class X extends be{constructor(n=""){super();this.name=n,this.commands=[],this.rawArgs=[],this.args=[],this.options={},this.globalCommand=new M(this),this.globalCommand.usage("<command> [options]")}usage(n){return this.globalCommand.usage(n),this}command(n,e,s){let t=new N(n,e||"",s,this);return t.globalCommand=this.globalCommand,this.commands.push(t),t}option(n,e,s){return this.globalCommand.option(n,e,s),this}help(n){return this.globalCommand.option("-h, --help","Display this message"),this.globalCommand.helpCallback=n,this.showHelpOnExit=!0,this}version(n,e="-v, --version"){return this.globalCommand.version(n,e),this.showVersionOnExit=!0,this}example(n){return this.globalCommand.example(n),this}outputHelp(){if(this.matchedCommand)this.matchedCommand.outputHelp();else this.globalCommand.outputHelp()}outputVersion(){this.globalCommand.outputVersion()}setParsedInfo({args:n,options:e},s,t){if(this.args=n,this.options=e,s)this.matchedCommand=s;if(t)this.matchedCommandName=t;return this}unsetMatchedCommand(){this.matchedCommand=void 0,this.matchedCommandName=void 0}parse(n=_e,{run:e=!0}={}){if(this.rawArgs=n,!this.name)this.name=n[1]?Ce(n[1]):"cli";let s=!0;for(let i of this.commands){let r=this.mri(n.slice(2),i),a=r.args[0];if(i.isMatched(a)){s=!1;let c=_(_({},r),{args:r.args.slice(1)});this.setParsedInfo(c,i,a),this.emit(`command:${a}`,i)}}if(s){for(let i of this.commands)if(i.name===""){s=!1;let r=this.mri(n.slice(2),i);this.setParsedInfo(r,i),this.emit("command:!",i)}}if(s){let i=this.mri(n.slice(2));this.setParsedInfo(i)}if(this.options.help&&this.showHelpOnExit)this.outputHelp(),e=!1,this.unsetMatchedCommand();if(this.options.version&&this.showVersionOnExit&&this.matchedCommandName==null)this.outputVersion(),e=!1,this.unsetMatchedCommand();let t={args:this.args,options:this.options};if(e)this.runMatchedCommand();if(!this.matchedCommand&&this.args[0])this.emit("command:*");return t}mri(n,e){let s=[...this.globalCommand.options,...e?e.options:[]],t=ke(s),i=[],r=n.indexOf("--");if(r>-1)i=n.slice(r+1),n=n.slice(0,r);let a=$e(n,t);a=Object.keys(a).reduce((g,x)=>{return _(_({},g),{[J(x)]:a[x]})},{_:[]});let c=a._,o={"--":i},l=e&&e.config.ignoreOptionDefaultValue?e.config.ignoreOptionDefaultValue:this.globalCommand.config.ignoreOptionDefaultValue,u=Object.create(null);for(let g of s){if(!l&&g.config.default!==void 0)for(let x of g.names)o[x]=g.config.default;if(Array.isArray(g.config.type)){if(u[g.name]===void 0)u[g.name]=Object.create(null),u[g.name].shouldTransform=!0,u[g.name].transformFunction=g.config.type[0]}}for(let g of Object.keys(a))if(g!=="_"){let x=g.split(".");ye(o,x,a[g]),Ae(o,u)}return{args:c,options:o}}runMatchedCommand(){let{args:n,options:e,matchedCommand:s}=this;if(!s||!s.commandAction)return;s.checkUnknownOptions(),s.checkOptionValue(),s.checkRequiredArgs();let t=[];return s.args.forEach((i,r)=>{if(i.variadic)t.push(n.slice(r));else t.push(n[r])}),t.push(e),s.commandAction.apply(this,t)}}var T=(n="")=>new X(n);import{existsSync as S,readdirSync as Se}from"fs";import{join as d,relative as I,resolve as p}from"path";var{$:m}=globalThis.Bun;function Ee(n=process.cwd()){let e=p(n),s=p("/");while(e!==s){let t=d(e,"package.json"),i=d(e,"turbo.json");if(S(t)&&S(i))return e;e=p(e,"..")}return process.cwd()}function Be(){let n=process.argv.slice(2),e="lint",s="ts",t=!1,i=[];for(let r of n)if(r.startsWith("--check-type="))e=r.split("=")[1];else if(r.startsWith("--lint-type="))s=r.split("=")[1];else if(r==="--fix")t=!0;else if(!r.startsWith("--"))i.push(r);return{config:{checkType:e,lintType:s,isFix:t},files:i}}function We(n,e){let s=p(e,n),t=I(e,s),i=[/^apps\/([^/]+)/,/^packages\/([^/]+)/,/^tooling\/([^/]+)/,/^testing\/([^/]+)/,/^scripts\/([^/]+)/];for(let r of i){let a=r.exec(t);if(a){let c=a[1];if(c)return c}}return null}function Re(n,e){switch(n){case"tsp":return[d(e,"packages/api/src/schema/")];case"md":return[d(e,"apps/wiki/docs/")];case"shell":{let s=d(e,".docker"),t=[];try{let i=Se(s,{recursive:!0}).filter((r)=>r.endsWith(".sh")).map((r)=>d(s,r));t.push(...i)}catch{}return t}case"actions":return[d(e,".github/")];case"textlint":return[d(e,"apps/wiki/docs/")];default:return[d(e,"apps/*/app/"),d(e,"packages/*/src/"),d(e,"tooling/*/src/"),d(e,"testing/*/src/")]}}function Ne(n){let e=n.replace(/\.(ts|tsx)$/,".test.$1");return S(e)?e:null}function Me(n){let e=n.replace(/\.test\.(ts|tsx)$/,".$1");return S(e)?e:null}async function Ie(n,e){let s=p(e,n),t=d(e,"node_modules",".bin","vitest"),i=Ne(s);if(!i)console.error(`Error: Test file not found for ${n}`),process.exit(1);await m`${t} run --coverage --coverage.include=${s} --coverage.threshold.lines=100 --coverage.threshold.functions=100 --coverage.threshold.branches=100 --coverage.threshold.statements=100 ${i}`.cwd(e).env({NODE_ENV:"test",PATH:process.env.PATH||""})}async function Ve(n,e,s){if(e!=="ts")console.error(`Error: --lint-type=${e} is not supported for test. Only --lint-type=ts is supported.`),process.exit(1);let t=n.map((r)=>p(s,r)),i=d(s,"node_modules",".bin","vitest");await m`${i} run ${t}`.cwd(s).env({NODE_ENV:"test",PATH:process.env.PATH||""})}async function ze(n,e,s){if(e!=="ts")console.error(`Error: --lint-type=${e} is not supported for coverage. Only --lint-type=ts is supported.`),process.exit(1);let t=d(s,"node_modules",".bin","vitest");if(n.length>0){let i=n.map((r)=>{let a=p(s,r);if(r.includes(".test."))return Me(a);return a}).filter((r)=>r!==null);if(i.length===0)console.error("Error: No source files found"),process.exit(1);for(let r of i)await Ie(I(s,r),s);return}await m`${t} run --coverage`.cwd(s).env({NODE_ENV:"test",PATH:process.env.PATH||""})}async function Ue(n,e,s,t,i){let r=t.map((a)=>p(i,a));if(e==="fmt"){if(s)await m`${n} format ${r}`.cwd(i);else await m`${n} format --check ${r}`.cwd(i);return}if(s)await m`${n} compile ${r}`.cwd(i);else await m`${n} compile ${r} --warn-as-error`.cwd(i)}function Le(n,e){if(n==="fmt")return e?"fmt":"fmt:check";return e?"lint:fix":"lint"}async function je(n,e,s,t){if(n.size===0)return;let r=Array.from(n).map((c)=>`--filter=${c}`).join(" "),a=Le(e,s);await m`turbo run ${a} ${r}`.cwd(t)}async function Ze(n,e,s,t,i){if(t.length===0)return;if(e==="fmt")if(s)await m`${n} check --write --only=formatter --organize-imports-enabled=true ${t}`.cwd(i);else await m`${n} check --only=formatter --organize-imports-enabled=true ${t}`.cwd(i);else if(s)await m`${n} check --write --only=linter --organize-imports-enabled=true ${t}`.cwd(i);else await m`${n} check --only=linter --organize-imports-enabled=true ${t}`.cwd(i)}async function Ge(n,e,s,t,i){let r=new Set,a=[];for(let c of t){let o=p(i,c),l=We(o,i);if(l)r.add(l);else a.push(o)}await je(r,e,s,i),await Ze(n,e,s,a,i)}async function qe(n,e,s,t){let i=s.map((a)=>p(t,a));if(n==="fmt"){if(e)await m`remark ${i} --output`.cwd(t);else await m`remark ${i} --frail --quiet`.cwd(t);return}let r=d(t,"node_modules",".bin","markdownlint-cli2");if(e)await m`${r} --fix ${i}`.cwd(t);else await m`${r} ${i}`.cwd(t)}async function He(n,e,s,t){let i=s.map((a)=>p(t,a));if(i.length===0){console.log("No shell files to check");return}if(n==="fmt"){if(e)await m`go run mvdan.cc/sh/v3/cmd/shfmt@v3.12.0 -w ${i}`.cwd(t);else await m`go run mvdan.cc/sh/v3/cmd/shfmt@v3.12.0 -l -d ${i}`.cwd(t);return}let r=i.map((a)=>I(t,a));await m`docker run --rm -v ${t}:/work -w /work -v ${t}/node_modules:/work/node_modules koalaman/shellcheck:v0.11.0 ${r}`}async function Pe(n,e,s,t){if(n==="fmt")console.error("Error: textlint does not support formatting. Use --check-type=lint instead."),process.exit(1);let i=s.map((a)=>p(t,a)),r=d(t,"node_modules",".bin","textlint");if(e)await m`${r} --fix ${i}`.cwd(t);else await m`${r} ${i}`.cwd(t)}async function Ke(n,e,s,t){if(n==="fmt"){let l=e?[]:["-lint"];l.push("-gitignore_excludes",...s);let u=Bun.spawn(["go","run","github.com/google/yamlfmt/cmd/yamlfmt@v0.20.0",...l],{stdout:"inherit",stderr:"inherit"});if(await u.exited,u.exitCode!==0)process.exit(u.exitCode||1);return}let i=Bun.spawn(["go","run","github.com/rhysd/actionlint/cmd/actionlint@v1.7.9"],{stdout:"inherit",stderr:"inherit"}),r=["go","run","github.com/suzuki-shunsuke/ghalint/cmd/ghalint@v1.5.4","run",...s],a=Bun.spawn(r,{stdout:"inherit",stderr:"inherit"}),[c,o]=await Promise.all([i.exited.then(()=>i.exitCode),a.exited.then(()=>a.exitCode)]);if(c!==0||o!==0)process.exit(1)}async function Ye(n,e,s){let{checkType:t,lintType:i}=n,r=d(s,"node_modules",".bin");switch(i){case"tsp":{let a=d(r,"tsp");await Ue(a,t,n.isFix,e,s);break}case"md":{await qe(t,n.isFix,e,s);break}case"shell":{await He(t,n.isFix,e,s);break}case"actions":{await Ke(t,n.isFix,e,s);break}case"textlint":{await Pe(t,n.isFix,e,s);break}default:{let a=d(r,"biome");await Ge(a,t,n.isFix,e,s)}}}async function F(){let n=Ee(),{config:e,files:s}=Be();try{if(e.checkType==="coverage")await ze(s,e.lintType,n);else if(e.checkType==="test")await Ve(s,e.lintType,n);else{let t=Re(e.lintType,n),i=s.length>0?s:t;await Ye(e,i,n)}process.exit(0)}catch{process.exit(1)}}var U=C(v(),1);import{existsSync as z,readFileSync as Fe}from"fs";import{dirname as De,join as L,relative as ne,resolve as A}from"path";var b=C(v(),1);function f(n,e,s="info"){let t={info:b.default.blue,success:b.default.green,warning:b.default.yellow,error:b.default.red},i;if(s==="success")i="\u2713";else if(s==="error")i="\u2717";else if(s==="warning")i="\u26A0";else i="\u2192";console.log(`  ${t[s](i)} ${n} ${e}`)}function Te(n,e="info"){let s={info:b.default.dim,success:b.default.green,warning:b.default.yellow},t;if(e==="success")t="\u2713";else if(e==="warning")t="\u26A0";else t="  ";console.log(`    ${s[e](t)} ${n}`)}class y{message;interval=null;frames=["\u280B","\u2819","\u2839","\u2838","\u283C","\u2834","\u2826","\u2827","\u2807","\u280F"];frameIndex=0;isActive=!1;constructor(n){this.message=n}start(){if(this.isActive)return;this.isActive=!0,this.frameIndex=0,this.interval=setInterval(()=>{let n=this.frames[this.frameIndex%this.frames.length];process.stdout.write(`\r    ${b.default.cyan(n)} ${b.default.dim(this.message)}`),this.frameIndex++},100)}stop(n=!0,e){if(!this.isActive)return;if(this.isActive=!1,this.interval)clearInterval(this.interval),this.interval=null;if(process.stdout.write(`\r${" ".repeat(80)}\r`),e)Te(e,n?"success":"warning")}}function w(n=process.cwd()){let e=A(n),s=A("/");while(e!==s){let t=L(e,"package.json");if(z(t))return e;e=A(e,"..")}return process.cwd()}function j(n,e){if(!z(n))return null;let s=De(n);while(s.startsWith(e)){let t=L(s,"package.json");if(z(t))return s;if(s===e)break;s=A(s,"..")}return null}function en(n,e){try{let s=L(n,"package.json"),t=Fe(s,"utf-8"),i=JSON.parse(t);return Boolean(i.scripts?.[e])}catch{return!1}}function te(n,e){let s=new Map;for(let t of n){let i=t.startsWith("/")?t:A(e,t),r=j(i,e);if(!r){f("\u26A0\uFE0F",`Skipping ${t}: no package.json found`,"warning");continue}let a=ne(e,r)||"root",c=ne(r,i);if(!s.has(r))s.set(r,{dir:r,name:a,files:[]});s.get(r).files.push(c)}return s}async function se(n,e,s){if(!en(n.dir,e))return f("\u26A0\uFE0F",`${n.name}: script "${e}" not found`,"warning"),{success:!1,skipped:!0};let t=new y(`Running ${e} in ${n.name}...`);t.start();try{let i=Bun.spawn(["bun","run",e,"--",...n.files],{cwd:n.dir,stdout:"pipe",stderr:"pipe"}),r=await i.exited;if(t.stop(r===0,`${n.name}: ${e} ${r===0?"completed":"failed"}`),r!==0){let a=await new Response(i.stderr).text();if(a)console.error(U.default.red(`
Error in ${n.name}:`)),console.error(a);return{success:!1,skipped:!1,exitCode:r}}return{success:!0,skipped:!1}}catch(i){return t.stop(!1,`${n.name}: ${e} failed`),console.error(U.default.red(`
Error in ${n.name}:`),i),{success:!1,skipped:!1}}}async function ie(n,e,s,t=!0){if(n.size===0)return f("\u2139\uFE0F","No packages to process","info"),!0;let i=Array.from(n.values());if(t){let r=await Promise.all(i.map((o)=>se(o,e,s))),a=r.map((o,l)=>({result:o,package:i[l]})).filter((o)=>o.result.success&&o.package!==void 0).map(({package:o})=>o.name),c=r.some((o)=>!o.success&&!o.skipped);if(a.length>0)f("\u2713",`Processed ${a.length} package(s): ${a.join(", ")}`,"success");return!c}else{let r=!1,a=[];for(let c of i){let o=await se(c,e,s);if(o.success)a.push(c.name);else if(!o.skipped)r=!0}if(a.length>0)f("\u2713",`Processed ${a.length} package(s): ${a.join(", ")}`,"success");return!r}}import{existsSync as nn}from"fs";import{join as sn}from"path";async function re(){let n=w(process.cwd()),e=sn(n,"infra","scripts","verify.ts");if(!nn(e))return console.error("[check infra] verify script not found:",e),!1;return await Bun.spawn(["bun","run",e],{cwd:n,stdout:"inherit",stderr:"inherit"}).exited===0}var h=C(v(),1);import{execSync as tn}from"child_process";import{existsSync as rn,readFileSync as an}from"fs";var on=[/^infra\/Pulumi\..*\.yaml$/,/\.env$/,/\.env\.local$/,/\.env\..*$/,/^\.git\/config$/,/^\.git\/credentials$/],ae=[/secure:/i,/api[_-]?key/i,/apikey/i,/password/i,/passwd/i,/pwd/i,/token/i,/access[_-]?token/i,/refresh[_-]?token/i,/secret/i,/secret[_-]?key/i,/credential/i,/credentials/i,/auth/i,/aws[_-]?access[_-]?key/i,/aws[_-]?secret[_-]?key/i,/private[_-]?key/i,/public[_-]?key/i,/bearer[_-]?token/i,/session[_-]?id/i,/session[_-]?secret/i],oe=[/^[A-Za-z0-9+/]{32,}={0,2}$/,/^[A-Za-z0-9_-]{20,}$/,/^sk-[A-Za-z0-9_-]+$/,/^pk_[A-Za-z0-9_-]+$/,/^ghp_[A-Za-z0-9_-]+$/,/^gho_[A-Za-z0-9_-]+$/,/^ghu_[A-Za-z0-9_-]+$/,/^ghs_[A-Za-z0-9_-]+$/,/^ghr_[A-Za-z0-9_-]+$/,/^AKIA[0-9A-Z]{16}$/,/^AIza[0-9A-Za-z_-]{35}$/,/^ya29\.[0-9A-Za-z_-]+$/,/^xox[baprs]-[0-9a-zA-Z-]{10,48}$/],cn=[/\.example$/,/\.sample$/,/\.template$/,/\.dist$/,/node_modules/,/\.git/,/dist/,/build/,/coverage/,/\.turbo/];function ln(){try{return tn("git diff --cached --name-only --diff-filter=ACM",{encoding:"utf-8"}).split(`
`).map((e)=>e.trim()).filter((e)=>e.length>0)}catch(n){return console.error("Error getting staged files:",n),[]}}function un(n){if(cn.some((e)=>e.test(n)))return!1;return on.some((e)=>e.test(n))}function mn(n){let e=[];if(/^\s*secure:/m.test(n))e.push("contains encrypted secrets (secure:) - use environment variables instead");return e}function dn(n){return n.length===0||n==="null"||n==="undefined"||n==="''"||n==='""'}function gn(n){let e=n.split("=");if(e.length<2)return null;let s=e[0]?.trim();if(!s)return null;let t=e.slice(1).join("=").trim().replaceAll(/(?:^["'])|(?:["']$)/g,"");return{key:s,value:t}}function fn(n,e,s){if(oe.some((t)=>t.test(e)))return`line ${s}: potential secret in '${n}'`;if(e.length>10)return`line ${s}: potential secret in '${n}' (long value detected)`;return null}function hn(n){let e=[],s=n.split(`
`);for(let t=0;t<s.length;t++){let i=s[t]?.trim();if(!i||i.startsWith("#"))continue;let r=gn(i);if(!r)continue;let{key:a,value:c}=r;if(!ae.some((l)=>l.test(a)))continue;if(dn(c))continue;let o=fn(a,c,t+1);if(o)e.push(o)}return e}function pn(n){let e=[];for(let s of ae){let t=new RegExp(`(${s.source})\\s*[:=]\\s*["']?([^"'
]{10,})["']?`,"gi"),i=n.matchAll(t);for(let r of i){let a=r[2];if(a&&oe.some((c)=>c.test(a)))e.push(`potential hardcoded secret detected: '${r[1]}'`)}}return e}function bn(n){if(!rn(n))return{found:!1,issues:[]};let e=an(n,"utf-8"),s=[];if(/^infra\/Pulumi\..*\.yaml$/.test(n))s.push(...mn(e));else if(/\.env/.test(n))s.push(...hn(e));else s.push(...pn(e));return{found:s.length>0,issues:s}}function xn(n){for(let{file:e,issues:s}of n){f("\u274C",e,"error");for(let t of s)console.error(h.default.red(`   ${t}`));console.error()}}function $n(){console.error(),f("\uD83D\uDCA1","Security best practices:","info"),console.error(h.default.dim("   \u2022 Use environment variables instead of hardcoding secrets")),console.error(h.default.dim("   \u2022 Never commit .env files with actual secrets")),console.error(h.default.dim("   \u2022 Use .env.example files for documentation")),console.error(h.default.dim("   \u2022 Use secret management (e.g., Cloudflare env, AWS Secrets Manager)")),console.error()}function wn(){console.error(h.default.yellow("   For Pulumi config files:")),console.error(h.default.dim("   \u2022 Do not commit secure: values; use environment variables")),console.error(h.default.dim("   \u2022 See infra/README.md for details")),console.error()}function kn(){console.error(h.default.yellow("   For .env files:")),console.error(h.default.dim("   \u2022 Add .env files to .gitignore")),console.error(h.default.dim("   \u2022 Use .env.example for documentation")),console.error(h.default.dim("   \u2022 Never commit actual secrets")),console.error()}function vn(n){if(console.error(),f("\u274C","Security issues detected:","error"),console.error(),xn(n),$n(),n.filter(({file:t})=>/^infra\/Pulumi\..*\.yaml$/.test(t)).length>0)wn();if(n.filter(({file:t})=>/\.env/.test(t)).length>0)kn()}async function ce(n){let e=n&&n.length>0?n:ln();if(e.length===0)return f("\u2139\uFE0F","No files to check","info"),!0;let s=e.filter(un);if(s.length===0)return f("\u2139\uFE0F","No security-sensitive files to check","info"),!0;let t=[];for(let i of s){let{found:r,issues:a}=bn(i);if(r)t.push({file:i,issues:a})}if(t.length>0)return vn(t),!1;return f("\u2713","No security issues detected","success"),!0}var ue=C(v(),1);import{execSync as yn}from"child_process";import{existsSync as An}from"fs";import{join as k,resolve as Cn}from"path";var{$:_n}=globalThis.Bun;function Z(n,e){let s=n.startsWith("/")?n:Cn(e,n),t=j(s,e);if(!t)return null;return t.replace(`${e}/`,"")}function On(n,e){return n.map((s)=>s.startsWith("/")?s.replace(`${e}/`,""):s).filter((s)=>!s.includes("worker-configuration.d.ts")&&!s.includes("/.astro/")&&!s.includes("/.turbo/")&&!s.includes("/.tanstack/")&&!s.includes("/.wrangler/")&&!s.includes("/build/")&&!s.includes("/dist/")&&!s.includes("/report/")&&!s.includes("/coverage/"))}function Sn(n){return n.filter((e)=>!e.endsWith(".test.ts")&&!e.endsWith(".test.tsx")&&(e.endsWith(".ts")||e.endsWith(".tsx")))}function En(n,e){return n.filter((s)=>{let i=(s.startsWith("/")?s:`${e}/${s}`).replace(/\.(ts|tsx)$/,".test.$1");return An(i)})}function Bn(n,e){let s=new Map,t=[];for(let i of n){let r=i.startsWith("/")?i.replace(`${e}/`,""):i,a=Z(r,e);if(a){if(!s.has(a))s.set(a,[]);s.get(a).push(r)}else t.push(r)}return{workspaceGroups:s,rootFiles:t}}function Wn(n,e,s){for(let[t]of n)s.push(`cd ${k(e,t)} && bun run fmt:check && bun run lint`)}function Rn(n,e,s){if(n.length===0)return;if(n.filter((i)=>i.endsWith(".ts")||i.endsWith(".tsx")||i.endsWith(".js")||i.endsWith(".jsx")).length>0)s.push(`cd ${e} && bunx turbo run fmt:check`,`cd ${e} && bunx turbo run lint`)}function Nn(n,e,s){for(let t of n){let i=t.startsWith("/")?t.replace(`${e}/`,""):t,r=Z(i,e),a=i.replace(/\.(ts|tsx)$/,".test.$1");if(r){let c=k(e,r),o=a.replace(`${r}/`,""),l=i.replace(`${r}/`,"");s.push(`cd ${c} && bun run test -- ${o}`,`cd ${c} && bun run coverage -- ${l}`)}}}function le(n,e){let s=On(n,e),t=Sn(s),i=En(t,e),r=s.some((l)=>l.endsWith(".ts")||l.endsWith(".tsx")),{workspaceGroups:a,rootFiles:c}=Bn(s,e),o=[];if(Wn(a,e,o),Rn(c,e,o),Nn(i,e,o),r)o.push(`cd ${e} && bunx turbo run typecheck`);return o}function Mn(n,e){if(e==="*.{ts,tsx}")return n.endsWith(".ts")||n.endsWith(".tsx");if(e==="*.config.js")return n.endsWith(".config.js");if(e==="*.md")return n.endsWith(".md");if(e==="*.sh")return n.endsWith(".sh");if(e==="*.tsp")return n.endsWith(".tsp");if(e==="**/*.test.{ts,tsx}")return n.includes(".test.ts")||n.includes(".test.tsx");if(e.startsWith(".github/")&&e.endsWith("/*.yml"))return n.startsWith(".github/")&&n.endsWith(".yml");return!1}function In(){try{return yn("git diff --cached --name-only --diff-filter=ACM",{encoding:"utf-8"}).split(`
`).map((e)=>e.trim()).filter((e)=>e.length>0)}catch(n){return console.error("Error getting staged files:",n),[]}}async function Vn(n){try{return await _n`sh -c ${n}`,!0}catch{return!1}}function zn(n,e){if(!Array.isArray(n)||n.length===0)return[];let s={".github/**/*.yml":(i)=>i.flatMap((r)=>[`bun run fmt:actions:check -- ${r}`,`bun run lint:actions:check -- ${r}`]),"*.{ts,tsx}":(i)=>le(i,e),"*.config.js":(i)=>le(i,e),"*.md":(i)=>{let r=i.filter((o)=>o.includes("apps/wiki/")),a=i.filter((o)=>!o.includes("apps/wiki/")),c=[];if(r.length>0){let o=r.map((l)=>{let u=l.match(/apps\/wiki\/(.+)/);return u?u[1]:l});c.push(`cd ${k(e,"apps/wiki")} && bun run fmt:md:check -- ${o.join(" ")}`,`cd ${k(e,"apps/wiki")} && bun run lint:md:check -- ${o.join(" ")}`,`cd ${k(e,"apps/wiki")} && bun run lint:textlint:check -- ${o.join(" ")}`)}if(a.length>0)f("\u26A0\uFE0F",`The following markdown files are outside apps/wiki/ and will not be checked: ${a.join(", ")}`,"warning");return c},"*.sh":(i)=>i.flatMap((r)=>[`bun run fmt:shell:check -- ${r}`,`bun run lint:shell:check -- ${r}`]),"*.tsp":(i)=>i.flatMap((r)=>[`bun run fmt:tsp:check -- ${r}`,`bun run lint:tsp:check -- ${r}`]),"**/*.test.{ts,tsx}":(i)=>{let r=[];for(let a of i){let c=a.startsWith("/")?a.replace(`${e}/`,""):a,o=Z(c,e);if(o){let l=k(e,o),u=c.replace(`${o}/`,"");r.push(`cd ${l} && bun run test -- ${u}`)}else f("\u26A0\uFE0F",`Test file ${c} is not in a workspace directory and will be skipped`,"warning")}return r}},t=[];for(let[i,r]of Object.entries(s)){let a=n.filter((c)=>Mn(c,i));if(a.length>0){let c=r(a);t.push(...c)}}return t}async function me(n){let e=w(),s=n&&n.length>0?n:In();if(s.length===0)return f("\u2139\uFE0F","No files to process","info"),!0;let t=zn(s,e);if(t.length===0)return f("\u2139\uFE0F","No commands to execute","info"),!0;let i=!1;for(let r of t){let a=new y(`Running: ${r}`);a.start();let c=await Vn(r);if(a.stop(c,c?`Completed: ${r}`:`Failed: ${r}`),!c)i=!0,console.error(ue.default.red(`Command failed: ${r}`))}return!i}var $=T("check");$.command("staged","\u30B9\u30C6\u30FC\u30B8\u3055\u308C\u305F\u30D5\u30A1\u30A4\u30EB\u3092\u30C1\u30A7\u30C3\u30AF\u3057\u307E\u3059").option("--files <files...>","\u30C1\u30A7\u30C3\u30AF\u3059\u308B\u30D5\u30A1\u30A4\u30EB\u306E\u30EA\u30B9\u30C8").action(async(n)=>{let e=[];if(Array.isArray(n.files))e=n.files;else if(n.files)e=[n.files];let s=await me(e.length>0?e:void 0);process.exit(s?0:1)});$.command("secrets","\u30BB\u30AD\u30E5\u30EA\u30C6\u30A3\u95A2\u9023\u306E\u30B7\u30FC\u30AF\u30EC\u30C3\u30C8\u3092\u7DB2\u7F85\u7684\u306B\u30C1\u30A7\u30C3\u30AF\u3057\u307E\u3059").option("--files <files...>","\u30C1\u30A7\u30C3\u30AF\u3059\u308B\u30D5\u30A1\u30A4\u30EB\u306E\u30EA\u30B9\u30C8").action(async(n)=>{let e=n.files||[],s=await ce(e.length>0?e:void 0);process.exit(s?0:1)});$.command("infra","infra \u7528 API \u30AD\u30FC\u30FB\u30C8\u30FC\u30AF\u30F3\u306E\u6709\u52B9\u6027\u3092\u691C\u8A3C\u3057\u307E\u3059\uFF08.env \u3092\u53C2\u7167\uFF09").action(async()=>{let n=await re();process.exit(n?0:1)});$.command("dispatch <command>","\u30D1\u30C3\u30B1\u30FC\u30B8\u3054\u3068\u306B\u30B3\u30DE\u30F3\u30C9\u3092\u5B9F\u884C\u3057\u307E\u3059").option("--files <files...>","\u51E6\u7406\u3059\u308B\u30D5\u30A1\u30A4\u30EB\u306E\u30EA\u30B9\u30C8").option("--no-parallel","\u4E26\u5217\u5B9F\u884C\u3092\u7121\u52B9\u5316").action(async(n,e)=>{let s=w(),t=e.files||[];if(t.length===0)console.error("Error: No files provided"),process.exit(1);let i=te(t,s),r=await ie(i,n,s,!e["no-parallel"]);process.exit(r?0:1)});$.command("*","\u65E2\u5B58\u306Echeck\u30B3\u30DE\u30F3\u30C9\u3092\u5B9F\u884C\u3057\u307E\u3059").action(async()=>{await F()});$.help();$.version("1.0.1");$.parse();
