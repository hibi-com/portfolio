#!/usr/bin/env bun
// @bun
var dn=Object.create;var{getPrototypeOf:hn,defineProperty:H,getOwnPropertyNames:fn}=Object;var pn=Object.prototype.hasOwnProperty;var y=(e,n,s)=>{s=e!=null?dn(hn(e)):{};let t=n||!e||!e.__esModule?H(s,"default",{value:e,enumerable:!0}):s;for(let i of fn(e))if(!pn.call(t,i))H(t,i,{get:()=>e[i],enumerable:!0});return t};var bn=(e,n)=>()=>(n||e((n={exports:{}}).exports,n),n.exports);var v=bn((Ke,U)=>{var W=process||{},D=W.argv||[],S=W.env||{},Xn=!(!!S.NO_COLOR||D.includes("--no-color"))&&(!!S.FORCE_COLOR||D.includes("--color")||W.platform==="win32"||(W.stdout||{}).isTTY&&S.TERM!=="dumb"||!!S.CI),Pn=(e,n,s=e)=>(t)=>{let i=""+t,r=i.indexOf(n,e.length);return~r?e+Tn(i,n,s,r)+n:e+i+n},Tn=(e,n,s,t)=>{let i="",r=0;do i+=e.substring(r,t)+s,r=t+n.length,t=e.indexOf(n,r);while(~t);return i+e.substring(r)},nn=(e=Xn)=>{let n=e?Pn:()=>String;return{isColorSupported:e,reset:n("\x1B[0m","\x1B[0m"),bold:n("\x1B[1m","\x1B[22m","\x1B[22m\x1B[1m"),dim:n("\x1B[2m","\x1B[22m","\x1B[22m\x1B[2m"),italic:n("\x1B[3m","\x1B[23m"),underline:n("\x1B[4m","\x1B[24m"),inverse:n("\x1B[7m","\x1B[27m"),hidden:n("\x1B[8m","\x1B[28m"),strikethrough:n("\x1B[9m","\x1B[29m"),black:n("\x1B[30m","\x1B[39m"),red:n("\x1B[31m","\x1B[39m"),green:n("\x1B[32m","\x1B[39m"),yellow:n("\x1B[33m","\x1B[39m"),blue:n("\x1B[34m","\x1B[39m"),magenta:n("\x1B[35m","\x1B[39m"),cyan:n("\x1B[36m","\x1B[39m"),white:n("\x1B[37m","\x1B[39m"),gray:n("\x1B[90m","\x1B[39m"),bgBlack:n("\x1B[40m","\x1B[49m"),bgRed:n("\x1B[41m","\x1B[49m"),bgGreen:n("\x1B[42m","\x1B[49m"),bgYellow:n("\x1B[43m","\x1B[49m"),bgBlue:n("\x1B[44m","\x1B[49m"),bgMagenta:n("\x1B[45m","\x1B[49m"),bgCyan:n("\x1B[46m","\x1B[49m"),bgWhite:n("\x1B[47m","\x1B[49m"),blackBright:n("\x1B[90m","\x1B[39m"),redBright:n("\x1B[91m","\x1B[39m"),greenBright:n("\x1B[92m","\x1B[39m"),yellowBright:n("\x1B[93m","\x1B[39m"),blueBright:n("\x1B[94m","\x1B[39m"),magentaBright:n("\x1B[95m","\x1B[39m"),cyanBright:n("\x1B[96m","\x1B[39m"),whiteBright:n("\x1B[97m","\x1B[39m"),bgBlackBright:n("\x1B[100m","\x1B[49m"),bgRedBright:n("\x1B[101m","\x1B[49m"),bgGreenBright:n("\x1B[102m","\x1B[49m"),bgYellowBright:n("\x1B[103m","\x1B[49m"),bgBlueBright:n("\x1B[104m","\x1B[49m"),bgMagentaBright:n("\x1B[105m","\x1B[49m"),bgCyanBright:n("\x1B[106m","\x1B[49m"),bgWhiteBright:n("\x1B[107m","\x1B[49m")}};U.exports=nn();U.exports.createColors=nn});import{EventEmitter as xn}from"events";function N(e){return e==null?[]:Array.isArray(e)?e:[e]}function $n(e,n,s,t){var i,r=e[n],a=~t.string.indexOf(n)?s==null||s===!0?"":String(s):typeof s==="boolean"?s:~t.boolean.indexOf(n)?s==="false"?!1:s==="true"||(e._.push((i=+s,i*0===0)?i:s),!!s):(i=+s,i*0===0)?i:s;e[n]=r==null?a:Array.isArray(r)?r.concat(a):[r,a]}function wn(e,n){e=e||[],n=n||{};var s,t,i,r,a,o={_:[]},c=0,l=0,u=0,d=e.length;let x=n.alias!==void 0,B=n.unknown!==void 0,G=n.default!==void 0;if(n.alias=n.alias||{},n.string=N(n.string),n.boolean=N(n.boolean),x)for(s in n.alias){t=n.alias[s]=N(n.alias[s]);for(c=0;c<t.length;c++)(n.alias[t[c]]=t.concat(s)).splice(c,1)}for(c=n.boolean.length;c-- >0;){t=n.alias[n.boolean[c]]||[];for(l=t.length;l-- >0;)n.boolean.push(t[l])}for(c=n.string.length;c-- >0;){t=n.alias[n.string[c]]||[];for(l=t.length;l-- >0;)n.string.push(t[l])}if(G){for(s in n.default)if(r=typeof n.default[s],t=n.alias[s]=n.alias[s]||[],n[r]!==void 0){n[r].push(s);for(c=0;c<t.length;c++)n[r].push(t[c])}}let q=B?Object.keys(n.alias):[];for(c=0;c<d;c++){if(i=e[c],i==="--"){o._=o._.concat(e.slice(++c));break}for(l=0;l<i.length;l++)if(i.charCodeAt(l)!==45)break;if(l===0)o._.push(i);else if(i.substring(l,l+3)==="no-"){if(r=i.substring(l+3),B&&!~q.indexOf(r))return n.unknown(i);o[r]=!1}else{for(u=l+1;u<i.length;u++)if(i.charCodeAt(u)===61)break;r=i.substring(l,u),a=i.substring(++u)||(c+1===d||(""+e[c+1]).charCodeAt(0)===45||e[++c]),t=l===2?[r]:r;for(u=0;u<t.length;u++){if(r=t[u],B&&!~q.indexOf(r))return n.unknown("-".repeat(l)+r);$n(o,r,u+1<t.length||a,n)}}}if(G){for(s in n.default)if(o[s]===void 0)o[s]=n.default[s]}if(x)for(s in o){t=n.alias[s]||[];while(t.length>0)o[t.shift()]=o[s]}return o}var J=(e)=>e.replace(/[<[].+/,"").trim(),kn=(e)=>{let n=/<([^>]+)>/g,s=/\[([^\]]+)\]/g,t=[],i=(o)=>{let c=!1,l=o[1];if(l.startsWith("..."))l=l.slice(3),c=!0;return{required:o[0].startsWith("<"),value:l,variadic:c}},r;while(r=n.exec(e))t.push(i(r));let a;while(a=s.exec(e))t.push(i(a));return t},vn=(e)=>{let n={alias:{},boolean:[]};for(let[s,t]of e.entries()){if(t.names.length>1)n.alias[t.names[0]]=t.names.slice(1);if(t.isBoolean)if(t.negated){if(!e.some((r,a)=>{return a!==s&&r.names.some((o)=>t.names.includes(o))&&typeof r.required==="boolean"}))n.boolean.push(t.names[0])}else n.boolean.push(t.names[0])}return n},K=(e)=>{return e.sort((n,s)=>{return n.length>s.length?-1:1})[0]},Y=(e,n)=>{return e.length>=n?e:`${e}${" ".repeat(n-e.length)}`},An=(e)=>{return e.replace(/([a-z])-([a-z])/g,(n,s,t)=>{return s+t.toUpperCase()})},Cn=(e,n,s)=>{let t=0,i=n.length,r=e,a;for(;t<i;++t)a=r[n[t]],r=r[n[t]]=t===i-1?s:a!=null?a:!!~n[t+1].indexOf(".")||!(+n[t+1]>-1)?{}:[]},yn=(e,n)=>{for(let s of Object.keys(n)){let t=n[s];if(t.shouldTransform){if(e[s]=Array.prototype.concat.call([],e[s]),typeof t.transformFunction==="function")e[s]=e[s].map(t.transformFunction)}}},_n=(e)=>{let n=/([^\\\/]+)$/.exec(e);return n?n[1]:""},Q=(e)=>{return e.split(".").map((n,s)=>{return s===0?An(n):n}).join(".")};class O extends Error{constructor(e){super(e);if(this.name=this.constructor.name,typeof Error.captureStackTrace==="function")Error.captureStackTrace(this,this.constructor);else this.stack=new Error(e).stack}}class X{constructor(e,n,s){if(this.rawName=e,this.description=n,this.config=Object.assign({},s),e=e.replace(/\.\*/g,""),this.negated=!1,this.names=J(e).split(",").map((t)=>{let i=t.trim().replace(/^-{1,2}/,"");if(i.startsWith("no-"))this.negated=!0,i=i.replace(/^no-/,"");return Q(i)}).sort((t,i)=>t.length>i.length?1:-1),this.name=this.names[this.names.length-1],this.negated&&this.config.default==null)this.config.default=!0;if(e.includes("<"))this.required=!0;else if(e.includes("["))this.required=!1;else this.isBoolean=!0}}var On=process.argv,En=`${process.platform}-${process.arch} node-${process.version}`;class M{constructor(e,n,s={},t){this.rawName=e,this.description=n,this.config=s,this.cli=t,this.options=[],this.aliasNames=[],this.name=J(e),this.args=kn(e),this.examples=[]}usage(e){return this.usageText=e,this}allowUnknownOptions(){return this.config.allowUnknownOptions=!0,this}ignoreOptionDefaultValue(){return this.config.ignoreOptionDefaultValue=!0,this}version(e,n="-v, --version"){return this.versionNumber=e,this.option(n,"Display version number"),this}example(e){return this.examples.push(e),this}option(e,n,s){let t=new X(e,n,s);return this.options.push(t),this}alias(e){return this.aliasNames.push(e),this}action(e){return this.commandAction=e,this}isMatched(e){return this.name===e||this.aliasNames.includes(e)}get isDefaultCommand(){return this.name===""||this.aliasNames.includes("!")}get isGlobalCommand(){return this instanceof R}hasOption(e){return e=e.split(".")[0],this.options.find((n)=>{return n.names.includes(e)})}outputHelp(){let{name:e,commands:n}=this.cli,{versionNumber:s,options:t,helpCallback:i}=this.cli.globalCommand,r=[{body:`${e}${s?`/${s}`:""}`}];if(r.push({title:"Usage",body:`  $ ${e} ${this.usageText||this.rawName}`}),(this.isGlobalCommand||this.isDefaultCommand)&&n.length>0){let c=K(n.map((l)=>l.rawName));r.push({title:"Commands",body:n.map((l)=>{return`  ${Y(l.rawName,c.length)}  ${l.description}`}).join(`
`)}),r.push({title:"For more info, run any command with the `--help` flag",body:n.map((l)=>`  $ ${e}${l.name===""?"":` ${l.name}`} --help`).join(`
`)})}let o=this.isGlobalCommand?t:[...this.options,...t||[]];if(!this.isGlobalCommand&&!this.isDefaultCommand)o=o.filter((c)=>c.name!=="version");if(o.length>0){let c=K(o.map((l)=>l.rawName));r.push({title:"Options",body:o.map((l)=>{return`  ${Y(l.rawName,c.length)}  ${l.description} ${l.config.default===void 0?"":`(default: ${l.config.default})`}`}).join(`
`)})}if(this.examples.length>0)r.push({title:"Examples",body:this.examples.map((c)=>{if(typeof c==="function")return c(e);return c}).join(`
`)});if(i)r=i(r)||r;console.log(r.map((c)=>{return c.title?`${c.title}:
${c.body}`:c.body}).join(`

`))}outputVersion(){let{name:e}=this.cli,{versionNumber:n}=this.cli.globalCommand;if(n)console.log(`${e}/${n} ${En}`)}checkRequiredArgs(){let e=this.args.filter((n)=>n.required).length;if(this.cli.args.length<e)throw new O(`missing required args for command \`${this.rawName}\``)}checkUnknownOptions(){let{options:e,globalCommand:n}=this.cli;if(!this.config.allowUnknownOptions){for(let s of Object.keys(e))if(s!=="--"&&!this.hasOption(s)&&!n.hasOption(s))throw new O(`Unknown option \`${s.length>1?`--${s}`:`-${s}`}\``)}}checkOptionValue(){let{options:e,globalCommand:n}=this.cli,s=[...n.options,...this.options];for(let t of s){let i=e[t.name.split(".")[0]];if(t.required){let r=s.some((a)=>a.negated&&a.names.includes(t.name));if(i===!0||i===!1&&!r)throw new O(`option \`${t.rawName}\` value is missing`)}}}}class R extends M{constructor(e){super("@@global@@","",{},e)}}var _=Object.assign;class P extends xn{constructor(e=""){super();this.name=e,this.commands=[],this.rawArgs=[],this.args=[],this.options={},this.globalCommand=new R(this),this.globalCommand.usage("<command> [options]")}usage(e){return this.globalCommand.usage(e),this}command(e,n,s){let t=new M(e,n||"",s,this);return t.globalCommand=this.globalCommand,this.commands.push(t),t}option(e,n,s){return this.globalCommand.option(e,n,s),this}help(e){return this.globalCommand.option("-h, --help","Display this message"),this.globalCommand.helpCallback=e,this.showHelpOnExit=!0,this}version(e,n="-v, --version"){return this.globalCommand.version(e,n),this.showVersionOnExit=!0,this}example(e){return this.globalCommand.example(e),this}outputHelp(){if(this.matchedCommand)this.matchedCommand.outputHelp();else this.globalCommand.outputHelp()}outputVersion(){this.globalCommand.outputVersion()}setParsedInfo({args:e,options:n},s,t){if(this.args=e,this.options=n,s)this.matchedCommand=s;if(t)this.matchedCommandName=t;return this}unsetMatchedCommand(){this.matchedCommand=void 0,this.matchedCommandName=void 0}parse(e=On,{run:n=!0}={}){if(this.rawArgs=e,!this.name)this.name=e[1]?_n(e[1]):"cli";let s=!0;for(let i of this.commands){let r=this.mri(e.slice(2),i),a=r.args[0];if(i.isMatched(a)){s=!1;let o=_(_({},r),{args:r.args.slice(1)});this.setParsedInfo(o,i,a),this.emit(`command:${a}`,i)}}if(s){for(let i of this.commands)if(i.name===""){s=!1;let r=this.mri(e.slice(2),i);this.setParsedInfo(r,i),this.emit("command:!",i)}}if(s){let i=this.mri(e.slice(2));this.setParsedInfo(i)}if(this.options.help&&this.showHelpOnExit)this.outputHelp(),n=!1,this.unsetMatchedCommand();if(this.options.version&&this.showVersionOnExit&&this.matchedCommandName==null)this.outputVersion(),n=!1,this.unsetMatchedCommand();let t={args:this.args,options:this.options};if(n)this.runMatchedCommand();if(!this.matchedCommand&&this.args[0])this.emit("command:*");return t}mri(e,n){let s=[...this.globalCommand.options,...n?n.options:[]],t=vn(s),i=[],r=e.indexOf("--");if(r>-1)i=e.slice(r+1),e=e.slice(0,r);let a=wn(e,t);a=Object.keys(a).reduce((d,x)=>{return _(_({},d),{[Q(x)]:a[x]})},{_:[]});let o=a._,c={"--":i},l=n&&n.config.ignoreOptionDefaultValue?n.config.ignoreOptionDefaultValue:this.globalCommand.config.ignoreOptionDefaultValue,u=Object.create(null);for(let d of s){if(!l&&d.config.default!==void 0)for(let x of d.names)c[x]=d.config.default;if(Array.isArray(d.config.type)){if(u[d.name]===void 0)u[d.name]=Object.create(null),u[d.name].shouldTransform=!0,u[d.name].transformFunction=d.config.type[0]}}for(let d of Object.keys(a))if(d!=="_"){let x=d.split(".");Cn(c,x,a[d]),yn(c,u)}return{args:o,options:c}}runMatchedCommand(){let{args:e,options:n,matchedCommand:s}=this;if(!s||!s.commandAction)return;s.checkUnknownOptions(),s.checkOptionValue(),s.checkRequiredArgs();let t=[];return s.args.forEach((i,r)=>{if(i.variadic)t.push(e.slice(r));else t.push(e[r])}),t.push(n),s.commandAction.apply(this,t)}}var T=(e="")=>new P(e);import{existsSync as E,readdirSync as Sn}from"fs";import{join as g,relative as z,resolve as p}from"path";var{$:m}=globalThis.Bun;function Wn(e=process.cwd()){let n=p(e),s=p("/");while(n!==s){let t=g(n,"package.json"),i=g(n,"turbo.json");if(E(t)&&E(i))return n;n=p(n,"..")}return process.cwd()}function Bn(){let e=process.argv.slice(2),n="lint",s="ts",t=!1,i=[];for(let r of e)if(r.startsWith("--check-type="))n=r.split("=")[1];else if(r.startsWith("--lint-type="))s=r.split("=")[1];else if(r==="--fix")t=!0;else if(!r.startsWith("--"))i.push(r);return{config:{checkType:n,lintType:s,isFix:t},files:i}}function Nn(e,n){let s=p(n,e),t=z(n,s),i=[/^apps\/([^/]+)/,/^packages\/([^/]+)/,/^tooling\/([^/]+)/,/^testing\/([^/]+)/,/^scripts\/([^/]+)/];for(let r of i){let a=r.exec(t);if(a){let o=a[1];if(o)return o}}return null}function Mn(e,n){switch(e){case"tsp":return[g(n,"packages/api/src/schema/")];case"md":return[g(n,"apps/wiki/docs/")];case"shell":{let s=g(n,".docker"),t=[];try{let i=Sn(s,{recursive:!0}).filter((r)=>r.endsWith(".sh")).map((r)=>g(s,r));t.push(...i)}catch{}return t}case"actions":return[g(n,".github/")];case"textlint":return[g(n,"apps/wiki/docs/")];default:return[g(n,"apps/*/app/"),g(n,"packages/*/src/"),g(n,"tooling/*/src/"),g(n,"testing/*/src/")]}}function Rn(e){let n=e.replace(/\.(ts|tsx)$/,".test.$1");return E(n)?n:null}function zn(e){let n=e.replace(/\.test\.(ts|tsx)$/,".$1");return E(n)?n:null}async function Un(e,n){let s=p(n,e),t=g(n,"node_modules",".bin","vitest"),i=Rn(s);if(!i)console.error(`Error: Test file not found for ${e}`),process.exit(1);await m`${t} run --coverage --coverage.include=${s} --coverage.threshold.lines=100 --coverage.threshold.functions=100 --coverage.threshold.branches=100 --coverage.threshold.statements=100 ${i}`.cwd(n).env({NODE_ENV:"test",PATH:process.env.PATH||""})}async function In(e,n,s){if(n!=="ts")console.error(`Error: --lint-type=${n} is not supported for test. Only --lint-type=ts is supported.`),process.exit(1);let t=e.map((r)=>p(s,r)),i=g(s,"node_modules",".bin","vitest");await m`${i} run ${t}`.cwd(s).env({NODE_ENV:"test",PATH:process.env.PATH||""})}async function Ln(e,n,s){if(n!=="ts")console.error(`Error: --lint-type=${n} is not supported for coverage. Only --lint-type=ts is supported.`),process.exit(1);let t=g(s,"node_modules",".bin","vitest");if(e.length>0){let i=e.map((r)=>{let a=p(s,r);if(r.includes(".test."))return zn(a);return a}).filter((r)=>r!==null);if(i.length===0)console.error("Error: No source files found"),process.exit(1);for(let r of i)await Un(z(s,r),s);return}await m`${t} run --coverage`.cwd(s).env({NODE_ENV:"test",PATH:process.env.PATH||""})}async function Vn(e,n,s,t,i){let r=t.map((a)=>p(i,a));if(n==="fmt"){if(s)await m`${e} format ${r}`.cwd(i);else await m`${e} format --check ${r}`.cwd(i);return}if(s)await m`${e} compile ${r}`.cwd(i);else await m`${e} compile ${r} --warn-as-error`.cwd(i)}function Zn(e,n){if(e==="fmt")return n?"fmt":"fmt:check";return n?"lint:fix":"lint"}async function jn(e,n,s,t){if(e.size===0)return;let r=Array.from(e).map((o)=>`--filter=${o}`).join(" "),a=Zn(n,s);await m`turbo run ${a} ${r}`.cwd(t)}async function Gn(e,n,s,t,i){if(t.length===0)return;if(n==="fmt")if(s)await m`${e} check --write --only=formatter --organize-imports-enabled=true ${t}`.cwd(i);else await m`${e} check --only=formatter --organize-imports-enabled=true ${t}`.cwd(i);else if(s)await m`${e} check --write --only=linter --organize-imports-enabled=true ${t}`.cwd(i);else await m`${e} check --only=linter --organize-imports-enabled=true ${t}`.cwd(i)}async function qn(e,n,s,t,i){let r=new Set,a=[];for(let o of t){let c=p(i,o),l=Nn(c,i);if(l)r.add(l);else a.push(c)}await jn(r,n,s,i),await Gn(e,n,s,a,i)}async function Hn(e,n,s,t){let i=s.map((a)=>p(t,a));if(e==="fmt"){if(n)await m`remark ${i} --output`.cwd(t);else await m`remark ${i} --frail --quiet`.cwd(t);return}let r=g(t,"node_modules",".bin","markdownlint-cli2");if(n)await m`${r} --fix ${i}`.cwd(t);else await m`${r} ${i}`.cwd(t)}async function Kn(e,n,s,t){let i=s.map((a)=>p(t,a));if(i.length===0){console.log("No shell files to check");return}if(e==="fmt"){if(n)await m`go run mvdan.cc/sh/v3/cmd/shfmt@v3.12.0 -w ${i}`.cwd(t);else await m`go run mvdan.cc/sh/v3/cmd/shfmt@v3.12.0 -l -d ${i}`.cwd(t);return}let r=i.map((a)=>z(t,a));await m`docker run --rm -v ${t}:/work -w /work -v ${t}/node_modules:/work/node_modules koalaman/shellcheck:v0.11.0 ${r}`}async function Yn(e,n,s,t){if(e==="fmt")console.error("Error: textlint does not support formatting. Use --check-type=lint instead."),process.exit(1);let i=s.map((a)=>p(t,a)),r=g(t,"node_modules",".bin","textlint");if(n)await m`${r} --fix ${i}`.cwd(t);else await m`${r} ${i}`.cwd(t)}async function Jn(e,n,s,t){if(e==="fmt"){let l=n?[]:["-lint"];l.push("-gitignore_excludes",...s);let u=Bun.spawn(["go","run","github.com/google/yamlfmt/cmd/yamlfmt@v0.20.0",...l],{stdout:"inherit",stderr:"inherit"});if(await u.exited,u.exitCode!==0)process.exit(u.exitCode||1);return}let i=Bun.spawn(["go","run","github.com/rhysd/actionlint/cmd/actionlint@v1.7.9"],{stdout:"inherit",stderr:"inherit"}),r=["go","run","github.com/suzuki-shunsuke/ghalint/cmd/ghalint@v1.5.4","run",...s],a=Bun.spawn(r,{stdout:"inherit",stderr:"inherit"}),[o,c]=await Promise.all([i.exited.then(()=>i.exitCode),a.exited.then(()=>a.exitCode)]);if(o!==0||c!==0)process.exit(1)}async function Qn(e,n,s){let{checkType:t,lintType:i}=e,r=g(s,"node_modules",".bin");switch(i){case"tsp":{let a=g(r,"tsp");await Vn(a,t,e.isFix,n,s);break}case"md":{await Hn(t,e.isFix,n,s);break}case"shell":{await Kn(t,e.isFix,n,s);break}case"actions":{await Jn(t,e.isFix,n,s);break}case"textlint":{await Yn(t,e.isFix,n,s);break}default:{let a=g(r,"biome");await qn(a,t,e.isFix,n,s)}}}async function F(){let e=Wn(),{config:n,files:s}=Bn();try{if(n.checkType==="coverage")await Ln(s,n.lintType,e);else if(n.checkType==="test")await In(s,n.lintType,e);else{let t=Mn(n.lintType,e),i=s.length>0?s:t;await Qn(n,i,e)}process.exit(0)}catch{process.exit(1)}}var L=y(v(),1);import{existsSync as I,readFileSync as Dn}from"fs";import{dirname as ne,join as V,relative as en,resolve as C}from"path";var b=y(v(),1);function h(e,n,s="info"){let t={info:b.default.blue,success:b.default.green,warning:b.default.yellow,error:b.default.red},i;if(s==="success")i="\u2713";else if(s==="error")i="\u2717";else if(s==="warning")i="\u26A0";else i="\u2192";console.log(`  ${t[s](i)} ${e} ${n}`)}function Fn(e,n="info"){let s={info:b.default.dim,success:b.default.green,warning:b.default.yellow},t;if(n==="success")t="\u2713";else if(n==="warning")t="\u26A0";else t="  ";console.log(`    ${s[n](t)} ${e}`)}class A{message;interval=null;frames=["\u280B","\u2819","\u2839","\u2838","\u283C","\u2834","\u2826","\u2827","\u2807","\u280F"];frameIndex=0;isActive=!1;constructor(e){this.message=e}start(){if(this.isActive)return;this.isActive=!0,this.frameIndex=0,this.interval=setInterval(()=>{let e=this.frames[this.frameIndex%this.frames.length];process.stdout.write(`\r    ${b.default.cyan(e)} ${b.default.dim(this.message)}`),this.frameIndex++},100)}stop(e=!0,n){if(!this.isActive)return;if(this.isActive=!1,this.interval)clearInterval(this.interval),this.interval=null;if(process.stdout.write(`\r${" ".repeat(80)}\r`),n)Fn(n,e?"success":"warning")}}function w(e=process.cwd()){let n=C(e),s=C("/");while(n!==s){let t=V(n,"package.json");if(I(t))return n;n=C(n,"..")}return process.cwd()}function Z(e,n){if(!I(e))return null;let s=ne(e);while(s.startsWith(n)){let t=V(s,"package.json");if(I(t))return s;if(s===n)break;s=C(s,"..")}return null}function ee(e,n){try{let s=V(e,"package.json"),t=Dn(s,"utf-8"),i=JSON.parse(t);return Boolean(i.scripts?.[n])}catch{return!1}}function tn(e,n){let s=new Map;for(let t of e){let i=t.startsWith("/")?t:C(n,t),r=Z(i,n);if(!r){h("\u26A0\uFE0F",`Skipping ${t}: no package.json found`,"warning");continue}let a=en(n,r)||"root",o=en(r,i);if(!s.has(r))s.set(r,{dir:r,name:a,files:[]});s.get(r).files.push(o)}return s}async function sn(e,n,s){if(!ee(e.dir,n))return h("\u26A0\uFE0F",`${e.name}: script "${n}" not found`,"warning"),{success:!1,skipped:!0};let t=new A(`Running ${n} in ${e.name}...`);t.start();try{let i=Bun.spawn(["bun","run",n,"--",...e.files],{cwd:e.dir,stdout:"pipe",stderr:"pipe"}),r=await i.exited;if(t.stop(r===0,`${e.name}: ${n} ${r===0?"completed":"failed"}`),r!==0){let a=await new Response(i.stderr).text();if(a)console.error(L.default.red(`
Error in ${e.name}:`)),console.error(a);return{success:!1,skipped:!1,exitCode:r}}return{success:!0,skipped:!1}}catch(i){return t.stop(!1,`${e.name}: ${n} failed`),console.error(L.default.red(`
Error in ${e.name}:`),i),{success:!1,skipped:!1}}}async function rn(e,n,s,t=!0){if(e.size===0)return h("\u2139\uFE0F","No packages to process","info"),!0;let i=Array.from(e.values());if(t){let r=await Promise.all(i.map((c)=>sn(c,n,s))),a=r.map((c,l)=>({result:c,package:i[l]})).filter((c)=>c.result.success&&c.package!==void 0).map(({package:c})=>c.name),o=r.some((c)=>!c.success&&!c.skipped);if(a.length>0)h("\u2713",`Processed ${a.length} package(s): ${a.join(", ")}`,"success");return!o}else{let r=!1,a=[];for(let o of i){let c=await sn(o,n,s);if(c.success)a.push(o.name);else if(!c.skipped)r=!0}if(a.length>0)h("\u2713",`Processed ${a.length} package(s): ${a.join(", ")}`,"success");return!r}}import{existsSync as se}from"fs";import{join as te}from"path";async function an(){let e=w(process.cwd()),n=te(e,"infra","scripts","verify.ts");if(!se(n))return console.error("[check infra] verify script not found:",n),!1;return await Bun.spawn(["bun","run",n],{cwd:e,stdio:"inherit"}).exited===0}var f=y(v(),1);import{execSync as ie}from"child_process";import{existsSync as re,readFileSync as ae}from"fs";var ce=[/^infra\/Pulumi\..*\.yaml$/,/\.env$/,/\.env\.local$/,/\.env\..*$/,/^\.git\/config$/,/^\.git\/credentials$/],cn=[/secure:/i,/api[_-]?key/i,/apikey/i,/password/i,/passwd/i,/pwd/i,/token/i,/access[_-]?token/i,/refresh[_-]?token/i,/secret/i,/secret[_-]?key/i,/credential/i,/credentials/i,/auth/i,/aws[_-]?access[_-]?key/i,/aws[_-]?secret[_-]?key/i,/private[_-]?key/i,/public[_-]?key/i,/bearer[_-]?token/i,/session[_-]?id/i,/session[_-]?secret/i],on=[/^[A-Za-z0-9+/]{32,}={0,2}$/,/^[A-Za-z0-9_-]{20,}$/,/^sk-[A-Za-z0-9_-]+$/,/^pk_[A-Za-z0-9_-]+$/,/^ghp_[A-Za-z0-9_-]+$/,/^gho_[A-Za-z0-9_-]+$/,/^ghu_[A-Za-z0-9_-]+$/,/^ghs_[A-Za-z0-9_-]+$/,/^ghr_[A-Za-z0-9_-]+$/,/^AKIA[0-9A-Z]{16}$/,/^AIza[0-9A-Za-z_-]{35}$/,/^ya29\.[0-9A-Za-z_-]+$/,/^xox[baprs]-[0-9a-zA-Z-]{10,48}$/],oe=[/\.example$/,/\.sample$/,/\.template$/,/\.dist$/,/node_modules/,/\.git/,/dist/,/build/,/coverage/,/\.turbo/];function le(){try{return ie("git diff --cached --name-only --diff-filter=ACM",{encoding:"utf-8"}).split(`
`).map((n)=>n.trim()).filter((n)=>n.length>0)}catch(e){return console.error("Error getting staged files:",e),[]}}function ue(e){if(oe.some((n)=>n.test(e)))return!1;return ce.some((n)=>n.test(e))}function me(e){let n=[];if(/^\s*secure:/m.test(e))n.push("contains encrypted secrets (secure:) - use environment variables instead");return n}function ge(e){return e.length===0||e==="null"||e==="undefined"||e==="''"||e==='""'}function de(e){let n=e.split("=");if(n.length<2)return null;let s=n[0]?.trim();if(!s)return null;let t=n.slice(1).join("=").trim().replaceAll(/(?:^["'])|(?:["']$)/g,"");return{key:s,value:t}}function he(e,n,s){if(on.some((t)=>t.test(n)))return`line ${s}: potential secret in '${e}'`;if(n.length>10)return`line ${s}: potential secret in '${e}' (long value detected)`;return null}function fe(e){let n=[],s=e.split(`
`);for(let t=0;t<s.length;t++){let i=s[t]?.trim();if(!i||i.startsWith("#"))continue;let r=de(i);if(!r)continue;let{key:a,value:o}=r;if(!cn.some((l)=>l.test(a)))continue;if(ge(o))continue;let c=he(a,o,t+1);if(c)n.push(c)}return n}function pe(e){let n=[];for(let s of cn){let t=new RegExp(`(${s.source})\\s*[:=]\\s*["']?([^"'
]{10,})["']?`,"gi"),i=e.matchAll(t);for(let r of i){let a=r[2];if(a&&on.some((o)=>o.test(a)))n.push(`potential hardcoded secret detected: '${r[1]}'`)}}return n}function be(e){if(!re(e))return{found:!1,issues:[]};let n=ae(e,"utf-8"),s=[];if(/^infra\/Pulumi\..*\.yaml$/.test(e))s.push(...me(n));else if(/\.env/.test(e))s.push(...fe(n));else s.push(...pe(n));return{found:s.length>0,issues:s}}function xe(e){for(let{file:n,issues:s}of e){h("\u274C",n,"error");for(let t of s)console.error(f.default.red(`   ${t}`));console.error()}}function $e(){console.error(),h("\uD83D\uDCA1","Security best practices:","info"),console.error(f.default.dim("   \u2022 Use environment variables instead of hardcoding secrets")),console.error(f.default.dim("   \u2022 Never commit .env files with actual secrets")),console.error(f.default.dim("   \u2022 Use .env.example files for documentation")),console.error(f.default.dim("   \u2022 Use secret management (e.g., Cloudflare env, AWS Secrets Manager)")),console.error()}function we(){console.error(f.default.yellow("   For Pulumi config files:")),console.error(f.default.dim("   \u2022 Do not commit secure: values; use environment variables")),console.error(f.default.dim("   \u2022 See infra/README.md for details")),console.error()}function ke(){console.error(f.default.yellow("   For .env files:")),console.error(f.default.dim("   \u2022 Add .env files to .gitignore")),console.error(f.default.dim("   \u2022 Use .env.example for documentation")),console.error(f.default.dim("   \u2022 Never commit actual secrets")),console.error()}function ve(e){if(console.error(),h("\u274C","Security issues detected:","error"),console.error(),xe(e),$e(),e.filter(({file:t})=>/^infra\/Pulumi\..*\.yaml$/.test(t)).length>0)we();if(e.filter(({file:t})=>/\.env/.test(t)).length>0)ke()}async function ln(e){let n=e&&e.length>0?e:le();if(n.length===0)return h("\u2139\uFE0F","No files to check","info"),!0;let s=n.filter(ue);if(s.length===0)return h("\u2139\uFE0F","No security-sensitive files to check","info"),!0;let t=[];for(let i of s){let{found:r,issues:a}=be(i);if(r)t.push({file:i,issues:a})}if(t.length>0)return ve(t),!1;return h("\u2713","No security issues detected","success"),!0}var mn=y(v(),1);import{execSync as Ae}from"child_process";import{existsSync as Ce}from"fs";import{join as k,resolve as ye}from"path";var{$:_e}=globalThis.Bun;function j(e,n){let s=e.startsWith("/")?e:ye(n,e),t=Z(s,n);if(!t)return null;return t.replace(`${n}/`,"")}function Oe(e,n){return e.map((s)=>s.startsWith("/")?s.replace(`${n}/`,""):s).filter((s)=>!s.includes("worker-configuration.d.ts")&&!s.includes("/.astro/")&&!s.includes("/.turbo/")&&!s.includes("/.tanstack/")&&!s.includes("/.wrangler/")&&!s.includes("/build/")&&!s.includes("/dist/")&&!s.includes("/report/")&&!s.includes("/coverage/"))}function Ee(e){return e.filter((n)=>!n.endsWith(".test.ts")&&!n.endsWith(".test.tsx")&&(n.endsWith(".ts")||n.endsWith(".tsx")))}function Se(e,n){return e.filter((s)=>{let i=(s.startsWith("/")?s:`${n}/${s}`).replace(/\.(ts|tsx)$/,".test.$1");return Ce(i)})}function We(e,n){let s=new Map,t=[];for(let i of e){let r=i.startsWith("/")?i.replace(`${n}/`,""):i,a=j(r,n);if(a){if(!s.has(a))s.set(a,[]);s.get(a).push(r)}else t.push(r)}return{workspaceGroups:s,rootFiles:t}}function Be(e,n,s){for(let[t]of e)s.push(`cd ${k(n,t)} && bun run fmt:check && bun run lint`)}function Ne(e,n,s){if(e.length===0)return;if(e.filter((i)=>i.endsWith(".ts")||i.endsWith(".tsx")||i.endsWith(".js")||i.endsWith(".jsx")).length>0)s.push(`cd ${n} && bunx turbo run fmt:check`,`cd ${n} && bunx turbo run lint`)}function Me(e,n,s){for(let t of e){let i=t.startsWith("/")?t.replace(`${n}/`,""):t,r=j(i,n),a=i.replace(/\.(ts|tsx)$/,".test.$1");if(r){let o=k(n,r),c=a.replace(`${r}/`,""),l=i.replace(`${r}/`,"");s.push(`cd ${o} && bun run test -- ${c}`,`cd ${o} && bun run coverage -- ${l}`)}}}function un(e,n){let s=Oe(e,n),t=Ee(s),i=Se(t,n),r=s.some((l)=>l.endsWith(".ts")||l.endsWith(".tsx")),{workspaceGroups:a,rootFiles:o}=We(s,n),c=[];if(Be(a,n,c),Ne(o,n,c),Me(i,n,c),r)c.push(`cd ${n} && bunx turbo run typecheck`);return c}function Re(e,n){if(n==="*.{ts,tsx}")return e.endsWith(".ts")||e.endsWith(".tsx");if(n==="*.config.js")return e.endsWith(".config.js");if(n==="*.md")return e.endsWith(".md");if(n==="*.sh")return e.endsWith(".sh");if(n==="*.tsp")return e.endsWith(".tsp");if(n==="**/*.test.{ts,tsx}")return e.includes(".test.ts")||e.includes(".test.tsx");if(n.startsWith(".github/")&&n.endsWith("/*.yml"))return e.startsWith(".github/")&&e.endsWith(".yml");return!1}function ze(){try{return Ae("git diff --cached --name-only --diff-filter=ACM",{encoding:"utf-8"}).split(`
`).map((n)=>n.trim()).filter((n)=>n.length>0)}catch(e){return console.error("Error getting staged files:",e),[]}}async function Ue(e){try{return await _e`sh -c ${e}`,!0}catch{return!1}}function Ie(e,n){if(!Array.isArray(e)||e.length===0)return[];let s={".github/**/*.yml":(i)=>i.flatMap((r)=>[`bun run fmt:actions:check -- ${r}`,`bun run lint:actions:check -- ${r}`]),"*.{ts,tsx}":(i)=>un(i,n),"*.config.js":(i)=>un(i,n),"*.md":(i)=>{let r=i.filter((c)=>c.includes("apps/wiki/")),a=i.filter((c)=>!c.includes("apps/wiki/")),o=[];if(r.length>0){let c=r.map((l)=>{let u=l.match(/apps\/wiki\/(.+)/);return u?u[1]:l});o.push(`cd ${k(n,"apps/wiki")} && bun run fmt:md:check -- ${c.join(" ")}`,`cd ${k(n,"apps/wiki")} && bun run lint:md:check -- ${c.join(" ")}`,`cd ${k(n,"apps/wiki")} && bun run lint:textlint:check -- ${c.join(" ")}`)}if(a.length>0)h("\u26A0\uFE0F",`The following markdown files are outside apps/wiki/ and will not be checked: ${a.join(", ")}`,"warning");return o},"*.sh":(i)=>i.flatMap((r)=>[`bun run fmt:shell:check -- ${r}`,`bun run lint:shell:check -- ${r}`]),"*.tsp":(i)=>i.flatMap((r)=>[`bun run fmt:tsp:check -- ${r}`,`bun run lint:tsp:check -- ${r}`]),"**/*.test.{ts,tsx}":(i)=>{let r=[];for(let a of i){let o=a.startsWith("/")?a.replace(`${n}/`,""):a,c=j(o,n);if(c){let l=k(n,c),u=o.replace(`${c}/`,"");r.push(`cd ${l} && bun run test -- ${u}`)}else h("\u26A0\uFE0F",`Test file ${o} is not in a workspace directory and will be skipped`,"warning")}return r}},t=[];for(let[i,r]of Object.entries(s)){let a=e.filter((o)=>Re(o,i));if(a.length>0){let o=r(a);t.push(...o)}}return t}async function gn(e){let n=w(),s=e&&e.length>0?e:ze();if(s.length===0)return h("\u2139\uFE0F","No files to process","info"),!0;let t=Ie(s,n);if(t.length===0)return h("\u2139\uFE0F","No commands to execute","info"),!0;let i=!1;for(let r of t){let a=new A(`Running: ${r}`);a.start();let o=await Ue(r);if(a.stop(o,o?`Completed: ${r}`:`Failed: ${r}`),!o)i=!0,console.error(mn.default.red(`Command failed: ${r}`))}return!i}var $=T("check");$.command("staged","\u30B9\u30C6\u30FC\u30B8\u3055\u308C\u305F\u30D5\u30A1\u30A4\u30EB\u3092\u30C1\u30A7\u30C3\u30AF\u3057\u307E\u3059").option("--files <files...>","\u30C1\u30A7\u30C3\u30AF\u3059\u308B\u30D5\u30A1\u30A4\u30EB\u306E\u30EA\u30B9\u30C8").action(async(e)=>{let n=[];if(Array.isArray(e.files))n=e.files;else if(e.files)n=[e.files];let s=await gn(n.length>0?n:void 0);process.exit(s?0:1)});$.command("secrets","\u30BB\u30AD\u30E5\u30EA\u30C6\u30A3\u95A2\u9023\u306E\u30B7\u30FC\u30AF\u30EC\u30C3\u30C8\u3092\u7DB2\u7F85\u7684\u306B\u30C1\u30A7\u30C3\u30AF\u3057\u307E\u3059").option("--files <files...>","\u30C1\u30A7\u30C3\u30AF\u3059\u308B\u30D5\u30A1\u30A4\u30EB\u306E\u30EA\u30B9\u30C8").action(async(e)=>{let n=e.files||[],s=await ln(n.length>0?n:void 0);process.exit(s?0:1)});$.command("infra","infra \u7528 API \u30AD\u30FC\u30FB\u30C8\u30FC\u30AF\u30F3\u306E\u6709\u52B9\u6027\u3092\u691C\u8A3C\u3057\u307E\u3059\uFF08.env \u3092\u53C2\u7167\uFF09").action(async()=>{let e=await an();process.exit(e?0:1)});$.command("dispatch <command>","\u30D1\u30C3\u30B1\u30FC\u30B8\u3054\u3068\u306B\u30B3\u30DE\u30F3\u30C9\u3092\u5B9F\u884C\u3057\u307E\u3059").option("--files <files...>","\u51E6\u7406\u3059\u308B\u30D5\u30A1\u30A4\u30EB\u306E\u30EA\u30B9\u30C8").option("--no-parallel","\u4E26\u5217\u5B9F\u884C\u3092\u7121\u52B9\u5316").action(async(e,n)=>{let s=w(),t=n.files||[];if(t.length===0)console.error("Error: No files provided"),process.exit(1);let i=tn(t,s),r=await rn(i,e,s,!n["no-parallel"]);process.exit(r?0:1)});$.command("*","\u65E2\u5B58\u306Echeck\u30B3\u30DE\u30F3\u30C9\u3092\u5B9F\u884C\u3057\u307E\u3059").action(async()=>{await F()});$.help();$.version("1.0.1");$.parse();
