# バグ修正テンプレート

## IMPORTANT: このテンプレートに従って一貫した形式でバグ修正を行うこと

## バグ修正ワークフロー

```text
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  1. 再現    │ ──▶ │  2. 原因特定 │ ──▶ │  3. テスト  │
│    確認     │     │    分析     │     │    作成     │
└─────────────┘     └─────────────┘     └─────────────┘
                                              │
┌─────────────┐     ┌─────────────┐           ▼
│  6. 検証    │ ◀── │  5. 修正    │ ◀── ┌─────────────┐
│    確認     │     │    実装     │     │  4. 失敗    │
└─────────────┘     └─────────────┘     │    確認     │
                                        └─────────────┘
```

## Step 1: バグの再現確認

### バグ情報

| 項目 | 内容 |
| ---- | ---- |
| 報告元 | {Issue番号/ユーザー報告} |
| 環境 | {本番/ステージング/ローカル} |
| 発生頻度 | {常に/時々/稀に} |
| 影響範囲 | {全ユーザー/特定ユーザー/特定条件} |
| 深刻度 | {Critical/High/Medium/Low} |

### 症状

```markdown
## 期待される動作

{正常時の動作}

## 実際の動作

{バグ発生時の動作}

## 再現手順

1. {手順1}
2. {手順2}
3. {手順3}

## エラーメッセージ

\`\`\`
{エラーメッセージ}
\`\`\`

## スクリーンショット/ログ

{証拠}
```

### 再現確認

```bash
# ローカルで再現確認
{再現コマンド}
```

- [ ] ローカルで再現できた
- [ ] 再現手順が明確

## Step 2: 原因特定・分析

### 調査ログ

```bash
# エラーログ確認
grep -r "{error-keyword}" logs/

# 関連コード検索
grep -r "{keyword}" --include="*.ts"

# Git履歴確認（いつから発生？）
git log --oneline -p {related-file}
```

### 原因分析

| 分析項目 | 結果 |
| -------- | ---- |
| エラー発生箇所 | {file}:{line} |
| 直接原因 | {直接的なエラー原因} |
| 根本原因 | {なぜそのエラーが発生したか} |
| 影響範囲 | {影響を受ける他の機能} |
| 導入時期 | {いつから発生/コミットハッシュ} |

### 原因特定

```typescript
// 問題のコード
// {file}:{line}
{問題のコード}

// 問題点の説明
// {なぜこのコードが問題か}
```

## Step 3: 再現テストの作成

### テストファイル

```typescript
// {path}.test.ts
import { describe, expect, test } from "vitest";

describe("{機能名}", () => {
    describe("バグ #{issue-number} の再現", () => {
        test("{バグの症状を説明するテスト名}", () => {
            // Given: バグが発生する条件
            const input = {
                // バグを引き起こす入力
            };

            // When: バグが発生する操作
            const result = targetFunction(input);

            // Then: 正しい動作（現在は失敗するはず）
            expect(result).toEqual({
                // 期待される正しい結果
            });
        });

        test("{境界値/エッジケース}", () => {
            // 関連するエッジケースのテスト
        });
    });
});
```

---

## Step 4: テスト失敗の確認

```bash
# テスト実行（失敗することを確認）
bun vitest run {test-file}
```

### 確認事項

- [ ] テストが期待通り失敗する
- [ ] 失敗理由がバグの症状と一致する

## Step 5: 修正の実装

### 修正方針

| 項目 | 内容 |
| ---- | ---- |
| 修正方針 | {どのように修正するか} |
| 変更ファイル | {変更が必要なファイル} |
| リスク | {修正による副作用のリスク} |
| 代替案 | {他の修正方法があれば} |

### 修正コード

```typescript
// Before: {file}:{line}
{修正前のコード}

// After: {file}:{line}
{修正後のコード}
```

### 修正理由

{なぜこの修正で問題が解決するのかの説明}

## Step 6: 検証確認

### テスト実行

```bash
# 作成したテストが通過することを確認
bun vitest run {test-file}

# 関連テストが通過することを確認
bun vitest run {related-tests}

# 全テスト実行
bun run test
```

### 手動検証

```bash
# ローカルで手動確認
bun run dev

# 再現手順を実行してバグが解消されていることを確認
```

### チェックリスト

- [ ] 作成したテストが通過
- [ ] 既存テストが全て通過
- [ ] 手動で再現手順を実行してバグが解消
- [ ] 型チェック通過
- [ ] リント通過
- [ ] 副作用がないことを確認

## 出力フォーマット

```markdown
## バグ修正完了レポート

### バグ概要

- **Issue**: #{number}
- **深刻度**: {severity}
- **影響範囲**: {scope}

### 原因

**直接原因**: {直接原因}

**根本原因**: {根本原因}

### 修正内容

| ファイル | 変更内容 |
| -------- | -------- |
| {file} | {変更内容} |

### 検証結果

| 項目 | 結果 |
| ---- | ---- |
| 再現テスト | ✅ Pass |
| 既存テスト | ✅ Pass ({count}件) |
| 手動検証 | ✅ 完了 |
| 型チェック | ✅ Pass |
| リント | ✅ Pass |

### 追加したテスト

- `{test-file}`: {テスト内容}

### 再発防止策

- {防止策1}
- {防止策2}
```
