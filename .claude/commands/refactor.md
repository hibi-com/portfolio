# リファクタリングコマンド

既存コードを安全にリファクタリングするワークフローを実行します。

## 使用方法

```text
/refactor [対象ファイル/ディレクトリ] [リファクタリング内容]
```

## ワークフロー

```text
1. 既存テスト確認 → 2. 計画立案 → 3. 段階的実施 → 4. テスト確認 → 5. レビュー
```

## 実行手順

### Step 1: 既存テストの確認

**使用スキル**: `/unit-test`

1. 対象コードのテストカバレッジを確認
2. テストがない場合は先に追加

カバレッジ: `bun run coverage`。  
対象のテストは同じディレクトリの `*.test.ts` または `docs/testing/testing-guide.md` の配置ルールを参照。

### Step 2: リファクタリング計画

**使用テンプレート**: `.claude/templates/workflow/refactoring.md`

1. リファクタリングの目的を明確化
2. 影響範囲の特定
3. 段階的な実施計画を立案

**計画項目**:

- 変更するファイル
- 変更の順序
- 各段階での確認項目

### Step 3: 段階的実施

**参照ルール**: 対象レイヤーに応じたルール

1. 小さな変更を1つずつ実施
2. 各変更後にテストを実行
3. テストが失敗したら即座に修正

変更のたびに `bun run test -- {関連テスト}` で回帰確認する。

### Step 4: 全テスト確認

**使用スキル**: `/unit-test`, `/typecheck`, `/lint`

1. 全ユニットテスト実行
2. 型チェック
3. リントチェック

全チェック: `bun run check`（fmt / lint / typecheck / test / knip）。  
個別は `bun run test`、`bun run typecheck`、`bun run lint`。

### Step 5: レビュー

**使用エージェント**: `review-agent`
**使用スキル**: `/review`

1. リファクタリング内容のセルフレビュー
2. 機能が変わっていないことを確認

## リファクタリングパターン

### 安全なリファクタリング

| パターン | 説明 |
| -------- | ---- |
| 変数のリネーム | 意味がより明確な名前に変更 |
| 関数の抽出 | 長い関数を小さな関数に分割 |
| 重複の除去 | DRY原則に従って共通化 |
| 型の厳格化 | `any` → 具体的な型 |

### 注意が必要なリファクタリング

| パターン | 注意点 |
| -------- | ------ |
| インターフェース変更 | 呼び出し元すべての更新が必要 |
| ディレクトリ移動 | インポートパスの更新が必要 |
| 依存関係の変更 | DIコンテナの更新が必要 |

## 関連リソース

| 種類 | リソース |
| ---- | -------- |
| ルール | `api.md`, `web.md`, `admin.md` |
| テンプレート | `workflow/refactoring.md` |
| エージェント | `review-agent` |
| スキル | `/unit-test`, `/typecheck`, `/lint`, `/review` |

## 出力フォーマット

```markdown
## リファクタリング完了レポート

### 対象
- ファイル/ディレクトリ: {target}
- 目的: {purpose}

### 変更内容
1. {change-1}
2. {change-2}

### テスト結果
- ユニットテスト: ✅ PASS
- 型チェック: ✅ PASS
- リント: ✅ PASS

### 確認事項
- [ ] 既存テスト通過
- [ ] 機能変更なし
- [ ] コード品質向上
```
