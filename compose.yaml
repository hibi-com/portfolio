include:
  - .docker/db/compose.yml

networks:
  default:
    name: portfolio_default

services:
  cache:
    image: redis:latest
    container_name: cache
    networks:
      - default
    ports:
      - target: 6379
        published: 6379
        protocol: tcp
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3
    restart: unless-stopped

  admin:
    build:
      context: apps/admin/dist
      dockerfile: apps/admin/Dockerfile
    image: portfolio-admin:local
    container_name: admin
    networks:
      - default
    ports:
      - target: 80
        published: 3001
        protocol: tcp
    environment:
      NODE_ENV: development
      VITE_API_URL: http://api:8787
      VITE_GOOGLE_ANALYTICS_ENABLED: false
      VITE_GOOGLE_TAG_MANAGER_ENABLED: false
      VITE_XSTATE_INSPECTOR_ENABLED: true
      VITE_SENTRY_DSN: dummy
      VITE_SENTRY_ENVIRONMENT: development
      VITE_SENTRY_TRACES_SAMPLE_RATE: 1
      VITE_SENTRY_REPLAY_SAMPLE_RATE: 0
      VITE_SENTRY_REPLAY_ON_ERROR_SAMPLE_RATE: 0
    restart: unless-stopped

  mock-apis:
    build:
      context: .
      dockerfile: testing/mock-apis/Dockerfile
    image: portfolio-mock-apis:local
    container_name: mock-apis
    networks:
      - default
    ports:
      - target: 3920
        published: 3920
        protocol: tcp
    environment:
      PORT: 3920
    restart: unless-stopped

  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    image: portfolio-api:local
    container_name: api
    networks:
      - default
      - db
    volumes:
      - .:/app
    ports:
      - target: 8787
        published: 8787
        protocol: tcp
    environment:
      NODE_ENV: development
      DATABASE_URL: mysql://user:password@tidb:4000/portfolio
      DATABASE_MAX_OPEN_CONNS: 1
      DATABASE_MAX_IDLE_CONNS: 10
      DATABASE_CONN_MAX_LIFETIME: 5m
      DATABASE_CONN_MAX_IDLE_TIME: 3m
      DATABASE_CA: dummy
      CACHE_URL: redis://:password@cache:6379
      CACHE_READ_TIMEOUT: 3s
      CACHE_WRITE_TIMEOUT: 3s
      BETTER_AUTH_SECRET: dummy
      BETTER_AUTH_URL: http://localhost:3000
      GOOGLE_CLIENT_ID: google-client-id
      GOOGLE_CLIENT_SECRET: google-client-secret
      FREEE_CLIENT_ID: mock-client-id
      FREEE_CLIENT_SECRET: mock-client-secret
      FREEE_AUTH_URL: http://mock-apis:3920
      FREEE_API_URL: http://mock-apis:3920
      FREEE_TIMEOUT: 150ms
      FREEE_MAX_RETRIES: 3
      FREEE_RETRY_TIMEOUT: 300ms
    depends_on:
      setup-db:
        condition: service_completed_successfully
      cache:
        condition: service_healthy
      mock-apis:
        condition: service_started
    restart: unless-stopped

  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    image: portfolio-web:local
    container_name: web
    networks:
      - default
    volumes:
      - .:/app
    ports:
      - target: 5173
        published: 5173
        protocol: tcp
    environment:
      NODE_ENV: development
      VITE_API_URL: http://api:8787
      VITE_GOOGLE_ANALYTICS_ENABLED: false
      VITE_GOOGLE_TAG_MANAGER_ENABLED: false
      VITE_XSTATE_INSPECTOR_ENABLED: true
      VITE_SENTRY_DSN: dummy
      VITE_SENTRY_ENVIRONMENT: development
      VITE_SENTRY_TRACES_SAMPLE_RATE: 1
      VITE_SENTRY_REPLAY_SAMPLE_RATE: 0
      VITE_SENTRY_REPLAY_ON_ERROR_SAMPLE_RATE: 0
    restart: unless-stopped

  wiki:
    build:
      context: apps/wiki/dist
      dockerfile: apps/wiki/Dockerfile
    image: portfolio-wiki:local
    container_name: wiki
    networks:
      - default
    ports:
      - target: 80
        published: 3002
        protocol: tcp
    environment:
      NODE_ENV: development
    restart: unless-stopped
